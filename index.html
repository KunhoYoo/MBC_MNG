<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MNG í˜„í™©íŒ (ë²„íŠ¼ ë¨¹í†µ ìˆ˜ì •)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Barun+Gothic&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#1477C9; --brand-soft:#E7F1FB; --ink:#0F172A; --muted:#5B6C80;
      --line:#E6EBF2; --bg:#F6F9FD; --card:#FFFFFF; --success:#16A34A;
      --shadow:0 10px 30px rgba(20,119,201,.08); --control-h:48px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{font-family:'Nanum Barun Gothic',system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    img.logo{cursor:pointer;max-width:360px;width:min(58%,360px);display:block;margin:18px auto 12px}
    #login-page,#status-page,#issue-page{display:none;width:100%}
    #login-page.active{display:flex} .screen{width:100%}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    #login-page{min-height:100vh;align-items:center;justify-content:center;flex-direction:column;padding:24px}
    .login-card{width:min(680px,92vw);background:var(--card);padding:22px;border-radius:20px;box-shadow:var(--shadow);border:1px solid var(--line)}
    .login-grid{display:grid;grid-template-columns:1fr;gap:12px}
    .login-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{width:100%;height:var(--control-h);padding:0 16px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff;outline:none}
    input.field:focus,select.field:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(20,119,201,.15)}
    select.field{appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:linear-gradient(45deg,transparent 50%,#8593a6 50%),linear-gradient(135deg,#8593a6 50%,transparent 50%);background-position:calc(100% - 20px) calc(50% - 3px),calc(100% - 15px) calc(50% - 3px);background-size:8px 8px,8px 8px;background-repeat:no-repeat}
    .btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:700;background:var(--brand);color:#fff;box-shadow:var(--shadow)}
    .btn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .login-footer{margin-top:6px;text-align:center;color:var(--muted);font-weight:700}
    .tables-grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:1024px){.tables-grid{grid-template-columns:1fr 1fr}}
    @media (max-width:1023px){.table-wrap.right{display:none}}
    .table-wrap{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{background:linear-gradient(180deg,var(--brand-soft),#F3F8FF);color:#133559;font-weight:800;font-size:14px;letter-spacing:.2px;text-align:left;padding:10px 12px;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:2;white-space:nowrap}
    thead th:first-child{width:110px}
    thead th:nth-child(2),thead th:nth-child(3),thead th:nth-child(4){width:28%}
    thead th:last-child{width:90px;text-align:center}
    tbody tr{border-bottom:1px solid var(--line);background:#fff}
    tbody tr.used td.left-stamp{border-left:6px solid var(--success)}
    tbody tr.unused td.left-stamp{border-left:6px solid #CBD5E1}
    tbody td{padding:8px 10px;vertical-align:middle}
    tbody td:last-child{text-align:center}
    .chip{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .chip-used{border-color:rgba(22,163,74,.45);background:linear-gradient(180deg,#E7F7EE,#F3FBF6);color:#065F46}
    .chip-idle{border-color:#E5E7EB;background:#F8FAFC;color:#334155}
    input[type="text"]{width:100%;height:38px;padding:0 12px;border:1px solid #D7DFEA;border-radius:12px;font-size:14px;outline:none;background:#fff}
    input[type="text"]::placeholder{color:#9DA8B8}
    input[type="text"]:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(20,119,201,.12)}
    .reset{width:38px;height:38px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;background:#FEE2E2;color:#B91C1C;border:1px solid #FCA5A5;cursor:pointer}
    @media (max-width:720px){.container{padding:10px} thead th{font-size:13px;padding:9px 10px} tbody td{padding:7px 8px} .chip{font-size:12px;padding:5px 8px} .reset{width:32px;height:32px} input[type="text"]{height:34px}}
    @media (max-width:480px){thead th{font-size:12px} th,td{padding-left:6px;padding-right:6px} td:nth-child(1){width:84px} td:nth-child(5){width:56px} input[type="text"]{height:32px;font-size:12px;padding:0 8px;border-radius:10px} .chip{padding:5px 8px;font-size:12px} .reset{width:34px;height:34px;min-width:34px;min-height:34px}}
    .issue-card{max-width:560px;margin:24px auto;background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:18px;display:grid;gap:12px}
    .issue-row{display:grid;gap:8px}
    .issue-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .issue-submit{display:block}
    .btn-issue{width:100%;padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:600;background:linear-gradient(180deg,#1e6fd1,#1159b2);color:#fff;box-shadow:var(--shadow)}
  </style>
</head>
<body>
  <div id="login-page" class="screen active">
    <img src="title_logo.png" class="logo" alt="íƒ€ì´í‹€ ë¡œê³ " onclick="toLogin()">
    <div class="login-card">
      <div class="login-grid">
        <input id="login-code" type="password" class="field" placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <div class="login-actions">
          <button id="btn-login-status" class="btn">í˜„í™©</button>
          <button id="btn-login-issue" class="btn secondary">ë¶ˆì¶œ</button>
        </div>
        <div class="login-footer">MNG í˜„í™© ìµœì‹ í™” ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ“¡</div>
      </div>
    </div>
  </div>

  <div id="status-page" class="screen">
    <img src="title_logo.png" class="logo" alt="íƒ€ì´í‹€ ë¡œê³ " onclick="toLogin()">
    <div class="container">
      <div class="tables-grid">
        <div class="table-wrap left">
          <table>
            <thead><tr><th>No.</th><th>ì‚¬ìš©ì</th><th>ë¶ˆì¶œì</th><th>ìœ„ì¹˜</th><th>ë°˜ë‚©</th></tr></thead>
            <tbody id="mng-left"></tbody>
          </table>
        </div>
        <div class="table-wrap right">
          <table>
            <thead><tr><th>No.</th><th>ì‚¬ìš©ì</th><th>ë¶ˆì¶œì</th><th>ìœ„ì¹˜</th><th>ë°˜ë‚©</th></tr></thead>
            <tbody id="mng-right"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="issue-page" class="screen">
    <img src="title_logo.png" class="logo" alt="íƒ€ì´í‹€ ë¡œê³ " onclick="toLogin()">
    <div class="issue-card">
      <div class="issue-row">
        <label for="issue-mng" style="font-weight:800">MNG ì„ íƒ</label>
        <select id="issue-mng" class="field"></select>
      </div>
      <div class="issue-grid">
        <div class="issue-row">
          <label style="font-weight:800">ì‚¬ìš©ì</label>
          <input id="issue-user" type="text" class="field" placeholder="ì´ë¦„">
        </div>
        <div class="issue-row">
          <label style="font-weight:800">ë¶ˆì¶œì</label>
          <input id="issue-issuer" type="text" class="field" placeholder="ìë™ ì…ë ¥" disabled>
        </div>
      </div>
      <div class="issue-row">
        <label style="font-weight:800">ìœ„ì¹˜</label>
        <input id="issue-region" type="text" class="field" placeholder="ì˜ˆ: ê°•ë‚¨">
      </div>
      <div class="issue-submit">
        <button id="btn-issue-submit" class="btn-issue">ë¶ˆì¶œ</button>
      </div>
    </div>
  </div>

  <!-- Non-module script: attach DOM listeners first, then dynamically import Firebase -->
  <script>
    // ----- App State & Utils -----
    const CODE_TO_USER = {
      "dbrjsgh":"ìœ ê±´í˜¸","rlawnsgml":"ê¹€ì¤€í¬","dlwlgns":"ì´ì§€í›ˆ","gkstldn":"í•œì‹œìš°","didtmdghks":"ì–‘ìŠ¹í™˜",
      "wjseowns":"ì „ëŒ€ì¤€","dlgmdfyd":"ì´í¥ë£¡","tlscjfdks":"ì‹ ì² ì•ˆ","wlstkdgns":"ì§„ìƒí›ˆ","rlaxogy":"ê¹€íƒœíš¨",
      "dlwhdgur":"ì´ì¢…í˜","rlatmdals":"ê¹€ìŠ¹ë¯¼","dlwlsgks":"ì´ì§„í•œ","rlawodnd":"ê¹€ì¬ì›…","didguswls":"ì–‘í˜„ì§„",
      "fbtmdgh":"ë¥˜ìŠ¹í˜¸","vuswoghks":"í¸ì¬í™˜","rlaalswns":"ê¹€ë¯¼ì¤€","wjdgnldyd":"ì •íœ˜ìš©","wjdwlgur":"ì •ì§€í˜",
      "rladudwls":"ê¹€ì˜ì§„","rlawotmd":"ê¹€ì¬ìŠ¹","rlaxowns":"ê¹€íƒœì¤€","qorcksgus":"ë°±ì°¬í˜„","dlgusdyd":"ì´í˜„ìš©",
      "tlaalswns":"ì‹¬ë¯¼ì¤€","qkrwndud":"ë°•ì£¼ì˜","dlwogk":"ì´ì¬í•˜","dldPeh":"ì´ì˜ˆë„","wkddudrms":"ì¥ì˜ê·¼"
    };
    const MNG_NUMBERS = [1,2,3,4,5,6,7,8,9,10,17,18,19,20,21,22,23,24,25,26];
    const mngList = MNG_NUMBERS.map(n=>({ num:`MNG-${String(n).padStart(2,'0')}`, vj:'', audio:'', region:'' }));
    let histories = {};
    let currentUserName = "";
    let intendedMode = "status";
    let listenersAttached = false;
    let dataListenersStarted = false;
    let syncTimer = null;
    let firebaseReady = false;
    let DB = null;

    function isUsed(item){ return Boolean((item.vj||'').trim() || (item.audio||'').trim() || (item.region||'').trim()); }
    function formatKTime(d){ const p=x=>String(x).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}ì‹œ${p(d.getMinutes())}ë¶„`; }
    function rowEl(num){ return document.querySelector(`tr[data-num="${num}"]`); }
    function setRowClass(num){
      const item = mngList.find(m=>m.num===num); const r = rowEl(num); if(!r||!item) return;
      r.classList.toggle('used', isUsed(item)); r.classList.toggle('unused', !isUsed(item));
      const chip = r.querySelector('.chip'); if(chip){ chip.classList.toggle('chip-used', isUsed(item)); chip.classList.toggle('chip-idle', !isUsed(item)); }
    }
    function toLogin(){
      document.getElementById('status-page').style.display='none';
      document.getElementById('issue-page').style.display='none';
      const lp = document.getElementById('login-page');
      lp.style.display='flex'; lp.classList.add('active');
      window.scrollTo({top:0, behavior:'auto'});
    }
    window.toLogin = toLogin;

    function buildTableOnce(){
      const tbodyLeft  = document.getElementById('mng-left');
      const tbodyRight = document.getElementById('mng-right');
      if (!tbodyLeft || !tbodyRight) return;
      tbodyLeft.innerHTML=''; tbodyRight.innerHTML='';
      const isMobile = window.matchMedia('(max-width:1023px)').matches;
      mngList.forEach((item, idx)=>{
        const tr = document.createElement('tr'); tr.dataset.num=item.num; tr.className=isUsed(item)?'used':'unused';
        tr.innerHTML = `
          <td class="left-stamp"><button class="chip ${isUsed(item)?'chip-used':'chip-idle'}" data-history="${item.num}">${item.num}</button></td>
          <td><input type="text" data-field="vj" placeholder="ì´ë¦„" value="${item.vj||''}"></td>
          <td><input type="text" data-field="audio" placeholder="ì´ë¦„" value="${item.audio||''}"></td>
          <td><input type="text" data-field="region" placeholder="ì˜ˆ: ê°•ë‚¨" value="${item.region||''}"></td>
          <td class="action-cell"><button class="reset" data-reset="${item.num}" title="ë°˜ë‚©(ì´ˆê¸°í™”)" aria-label="ë°˜ë‚©">âŸ²</button></td>`;
        (isMobile || idx<10 ? tbodyLeft : tbodyRight).appendChild(tr);
      });
      if (!listenersAttached){
        [tbodyLeft, tbodyRight].forEach(tbody=>{
          tbody.addEventListener('input', (e)=>{
            const inp = e.target.closest('input[data-field]'); if(!inp) return;
            const tr = e.target.closest('tr'); if(!tr) return;
            const num = tr.dataset.num; const field = inp.dataset.field;
            const item = mngList.find(m=>m.num===num); if(!item) return;
            item[field]=inp.value; setRowClass(num); refreshIssueDropdown();
          });
          tbody.addEventListener('click', async (e)=>{
            const resetBtn = e.target.closest('button[data-reset]');
            if (resetBtn){
              const num = resetBtn.dataset.reset; const item = mngList.find(m=>m.num===num); if(!item) return;
              if (!confirm('í•´ë‹¹ MNG ë°˜ë‚©ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
              if (isUsed(item)){ await appendHistory(num, { vj:item.vj||'', audio:item.audio||'', region:item.region||'', returnedAt:new Date().toISOString() }); }
              item.vj=item.audio=item.region='';
              const tr = rowEl(num); if(tr){ tr.querySelectorAll('input').forEach(i=>i.value=''); }
              setRowClass(num);
              if(firebaseReady){ await DB.setData(`mngData/${num}`, { vj:'', audio:'', region:'' }); }
              refreshIssueDropdown(); return;
            }
            const histBtn = e.target.closest('button[data-history]');
            if (histBtn){
              const num = histBtn.dataset.history;
              const arr = histories && histories[num] ? histories[num] : [];
              if (!arr.length){ alert(`<${num} ê³¼ê±° ê¸°ë¡>\nê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`); return; }
              const safeTime = ts => { if(!ts) return '-'; const d=new Date(ts); return isNaN(d)?'-':formatKTime(d); };
              const lines = arr.map(e => {
                const ts = e.returnedAt || e.issuedAt; const action = e.returnedAt ? 'ë°˜ë‚©' : (e.issuedAt ? 'ë¶ˆì¶œ' : '');
                return `${e.vj||'-'} / ${e.audio||'-'} / ${e.region||'-'} / ${safeTime(ts)} ${action}`;
              });
              alert(`<${num} ê³¼ê±° ê¸°ë¡>\n` + lines.join('\n'));
            }
          });
        });
        listenersAttached = true;
      }
    }

    function populateFromSnapshot(data){
      mngList.forEach(item=>{
        if(data && data[item.num]){ Object.assign(item, data[item.num]); }
        const r = rowEl(item.num); if(!r) return;
        const vj=r.querySelector('input[data-field="vj"]');
        const au=r.querySelector('input[data-field="audio"]');
        const re=r.querySelector('input[data-field="region"]');
        if(vj && vj!==document.activeElement) vj.value=item.vj||'';
        if(au && au!==document.activeElement) au.value=item.audio||'';
        if(re && re!==document.activeElement) re.value=item.region||'';
        setRowClass(item.num);
      });
      refreshIssueDropdown();
    }

    function buildIssueDropdown(all=true){
      const sel = document.getElementById('issue-mng'); if(!sel) return;
      sel.innerHTML='<option value="" disabled selected>ì„ íƒ</option>';
      MNG_NUMBERS.forEach(n=>{
        const label = `MNG-${String(n).padStart(2,'0')}`;
        if(!all){
          const item = mngList.find(m=>m.num===label);
          if(item && isUsed(item)) return;
        }
        const opt=document.createElement('option'); opt.value=label; opt.textContent=label; sel.appendChild(opt);
      });
    }
    function refreshIssueDropdown(){ buildIssueDropdown(false); }

    async function appendHistory(num, entry){
      const arr = histories[num] ? [...histories[num]] : [];
      arr.unshift(entry); histories[num] = arr.slice(0,5);
      if(firebaseReady){ await DB.setData(`mngHistory/${num}`, histories[num]); }
    }

    async function submitIssue(){
      const sel=document.getElementById('issue-mng');
      const userEl=document.getElementById('issue-user');
      const regionEl=document.getElementById('issue-region');
      if(!sel) return;
      const mng=sel.value; const user=(userEl?.value||'').trim(); const region=(regionEl?.value||'').trim();
      if(!mng){ alert('MNGë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      if(!user){ alert('ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      if(!region){ alert('ìœ„ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      await appendHistory(mng, { vj:user, audio: currentUserName || '', region, issuedAt: new Date().toISOString() });
      if(firebaseReady){ await DB.setData(`mngData/${mng}`, { vj:user, audio: currentUserName || '', region }); }
      alert('ë¶ˆì¶œ ë˜ì—ˆìŠµë‹ˆë‹¤!'); if(userEl) userEl.value=''; if(regionEl) regionEl.value=''; refreshIssueDropdown();
    }

    function showScreen(id){
      document.getElementById('login-page').style.display = id==='login' ? 'flex':'none';
      document.getElementById('status-page').style.display = id==='status' ? 'block':'none';
      document.getElementById('issue-page').style.display  = id==='issue'  ? 'block':'none';
      if(id==='login'){ document.getElementById('login-page').classList.add('active'); }
      window.scrollTo({top:0, behavior:'auto'});
    }

    function attachLoginHandlers(){
      const codeInput=document.getElementById('login-code');
      const btnStatus=document.getElementById('btn-login-status');
      const btnIssue=document.getElementById('btn-login-issue');
      const btnIssueSubmit=document.getElementById('btn-issue-submit');

      function chooseMode(m){ intendedMode=m; }
      function login(){
        const code = (codeInput?.value||'').trim();
        if(CODE_TO_USER[code]){
          currentUserName = CODE_TO_USER[code];
          if(intendedMode==='issue'){
            showScreen('issue');
            buildIssueDropdown(false);
            const issuer=document.getElementById('issue-issuer'); if(issuer) issuer.value=currentUserName||'';
            if(firebaseReady && !dataListenersStarted){ DB.startListeners(); }
          }else{
            showScreen('status');
            buildTableOnce();
            if(firebaseReady && !dataListenersStarted){ DB.startListeners(); }
            if(firebaseReady && !syncTimer){ syncTimer=setInterval(()=>DB.syncAll(), 5000); }
          }
        }else{
          alert('ì˜ëª»ëœ ë¡œê·¸ì¸ ì½”ë“œì…ë‹ˆë‹¤.');
        }
      }
      if(btnStatus) btnStatus.addEventListener('click', ()=>{ chooseMode('status'); login(); });
      if(btnIssue)  btnIssue.addEventListener('click',  ()=>{ chooseMode('issue');  login(); });
      if(btnIssueSubmit) btnIssueSubmit.addEventListener('click', submitIssue);
      if(codeInput) codeInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ chooseMode('status'); login(); } });
    }

    // Run after DOM
    window.addEventListener('DOMContentLoaded', ()=>{
      attachLoginHandlers();
      showScreen('login');
      buildTableOnce(); // prepares empty table so UI feels alive

      // Dynamic import Firebase so UI doesn't die if imports fail
      (async ()=>{
        try{
          const [{ initializeApp }, { getDatabase, ref, set, onValue }] = await Promise.all([
            import('https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js')
          ]);
          const firebaseConfig = {
            apiKey: "AIzaSyADWorIbKPZZoWx7qAriiCA2lYtf-MSdAA",
            authDomain: "mbc-mng.firebaseapp.com",
            databaseURL: "https://mbc-mng-default-rtdb.firebaseio.com",
            projectId: "mbc-mng",
            storageBucket: "mbc-mng.firebasestorage.app",
            messagingSenderId: "845487713315",
            appId: "1:845487713315:web:d8559559fa98870fde5596"
          };
          const app = initializeApp(firebaseConfig);
          const db = getDatabase(app);

          // DB helper wrapper
          DB = {
            setData: (path, value) => set(ref(db, path), value),
            startListeners: () => {
              if(dataListenersStarted) return;
              onValue(ref(db,'mngData'), snap => populateFromSnapshot(snap.val()));
              onValue(ref(db,'mngHistory'), snap => { histories = snap.val() || {}; });
              dataListenersStarted = true;
            },
            syncAll: () => {
              const obj={}; mngList.forEach(it => obj[it.num] = { vj:it.vj||'', audio:it.audio||'', region:it.region||'' });
              set(ref(db,'mngData'), obj);
            }
          };
          firebaseReady = true;
        }catch(err){
          console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', err);
          // UIëŠ” ê³„ì† ë™ì‘í•˜ê³ , DBë§Œ ë¹„í™œì„± ì²˜ë¦¬
        }
      })();
    });
  </script>
</body>
</html>
