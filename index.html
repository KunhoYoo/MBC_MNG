<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MNG ì¸ì œìŠ¤íŠ¸ ë…¸íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Barun+Gothic&display=swap" rel="stylesheet">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    // ==== Firebase ====
    const firebaseConfig = {
  apiKey: "AIzaSyADWorIbKPZZoWx7qAriiCA2lYtf-MSdAA",
  authDomain: "mbc-mng.firebaseapp.com",
  databaseURL: "https://mbc-mng-default-rtdb.firebaseio.com",
  projectId: "mbc-mng",
  storageBucket: "mbc-mng.firebasestorage.app",
  messagingSenderId: "845487713315",
  appId: "1:845487713315:web:d8559559fa98870fde5596"
};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ==== State ====
    const CODE_TO_USER = { "dbrjsgh": "ìœ ê±´í˜¸" }; // í•œê¸€ í‚¤íŒ¨ë“œ 'ìœ ê±´í˜¸'
    const MNG_NUMBERS = [1,2,3,4,6,7,8,9,17,18,19,20,21,22,23,24,25,26,27];
    const mngList = MNG_NUMBERS.map(n => ({ num: `MNG-${String(n).padStart(2,'0')}`, vj:'', audio:'', region:'' }));
    let histories = {};
    let currentUserName = "";
    let intendedMode = "status"; // 'status' or 'issue'

    // Helpers
    const tbody = document.getElementById('mng-table-body');
    const issueMngSel = document.getElementById('issue-mng');
    const issueUser = document.getElementById('issue-user');
    const issueRegion = document.getElementById('issue-region');
    const issueIssuer = document.getElementById('issue-issuer');

    function isUsed(item){
      return Boolean((item.vj||'').trim() || (item.audio||'').trim() || (item.region||'').trim());
    }
    function formatKTime(d){
      const pad = (x)=> String(x).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}ì‹œ${pad(d.getMinutes())}ë¶„`;
    }
    function rowEl(num){ return document.querySelector(`tr[data-num="${num}"]`); }
    function setRowClass(num){
      const item = mngList.find(m=>m.num===num);
      const r = rowEl(num);
      if (!r || !item) return;
      r.classList.toggle('used', isUsed(item));
      r.classList.toggle('unused', !isUsed(item));
      const chip = r.querySelector('.chip');
      if (chip){
        chip.classList.toggle('chip-used', isUsed(item));
        chip.classList.toggle('chip-idle', !isUsed(item));
      }
    }

    // Build table ONCE to keep focus/Tab order stable
    function buildTableOnce(){
      if (!tbody) return;
      tbody.innerHTML = '';
      mngList.forEach(item=>{
        const tr = document.createElement('tr');
        tr.dataset.num = item.num;
        tr.className = 'unused';
        tr.innerHTML = `
          <td class="left-stamp">
            <button class="chip chip-idle" onclick="window.showHistory('${item.num}')">${item.num}</button>
          </td>
          <td><input type="text" data-field="vj" placeholder="ì´ë¦„"></td>
          <td><input type="text" data-field="audio" placeholder="ì´ë¦„"></td>
          <td><input type="text" data-field="region" placeholder="ì˜ˆ: ê°•ë‚¨"></td>
          <td class="action-cell">
            <button class="reset" title="ë°˜ë‚©(ì´ˆê¸°í™”)" onclick="window.resetRow('${item.num}')" aria-label="ë°˜ë‚©">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true">
                <path d="M9 3h6a1 1 0 0 1 1 1v1h3a1 1 0 1 1 0 2h-1v12a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3V7H5a1 1 0 1 1 0-2h3V4a1 1 0 0 1 1-1zm1 2v0h4V4h-4v1zm-1 4a1 1 0 0 1 2 0v8a1 1 0 1 1-2 0V9zm6 0a1 1 0 0 1 2 0v8a1 1 0 1 1-2 0V9z"/>
              </svg>
            </button>
          </td>`;
        tbody.appendChild(tr);

        // attach handlers per input (no re-render)
        tr.querySelectorAll('input').forEach(inp=>{
          inp.addEventListener('input', ()=>{
            const field = inp.dataset.field;
            const value = inp.value;
            const target = mngList.find(m=>m.num===item.num);
            target[field] = value;
            setRowClass(item.num); // only toggle class; do not rebuild
            refreshIssueDropdown(); // keep "ë¶ˆì¶œ" ë“œë¡­ë‹¤ìš´ì—ì„œ ì‚¬ìš© ì¤‘ ì¥ë¹„ ì œì™¸
          });
        });
      });
    }

    async function appendHistory(num, entry){
      const arr = histories[num] ? [...histories[num]] : [];
      arr.unshift(entry);
      histories[num] = arr.slice(0,5);
      await set(ref(db, `mngHistory/${num}`), histories[num]);
    }

    window.resetRow = async function(num){
      const item = mngList.find(m=>m.num===num);
      if (!item) return;
      if (!confirm('í•´ë‹¹ MNG ë°˜ë‚©ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      // Save history first if used
      if (isUsed(item)){
        await appendHistory(num, {
          vj: item.vj || '', audio: item.audio || '', region: item.region || '',
          returnedAt: new Date().toISOString()
        });
      }

      // Clear local
      item.vj = item.audio = item.region = '';

      // Clear inputs in-place (keep elements & focus behavior)
      const r = rowEl(num);
      if (r){ r.querySelectorAll('input').forEach(inp => inp.value = ''); }
      setRowClass(num);

      // Clear DB for this single row immediately (no delay)
      await set(ref(db, `mngData/${num}`), { vj:'', audio:'', region:'' });

      // í˜„í™©íŒì€ onValue ë¦¬ìŠ¤ë„ˆë¡œ ìë™ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
      // í•„ìš” ì‹œ ì´ í–‰ë§Œ ì‹œê°ì ìœ¼ë¡œ ë¹„ì›€ ì²˜ë¦¬ ì™„ë£Œ.
      refreshIssueDropdown();
    };

    window.showHistory = function(num){
      const arr = histories && histories[num] ? histories[num] : [];
      if (!arr.length){ alert(`<${num} ê³¼ê±° ê¸°ë¡>\nê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`); return; }
      const lines = arr.map(e => `${e.vj||'-'} / ${e.audio||'-'} / ${e.region||'-'} / ${formatKTime(new Date(e.returnedAt))} ë°˜ë‚©`);
      alert(`<${num} ê³¼ê±° ê¸°ë¡>\n` + lines.join('\n'));
    };

    function populateFromSnapshot(data){
      // do NOT rebuild table; only set input values & state
      mngList.forEach(item => {
        if (data && data[item.num]){ Object.assign(item, data[item.num]); }
        const r = rowEl(item.num);
        if (r){
          const vj = r.querySelector('input[data-field="vj"]');
          const au = r.querySelector('input[data-field="audio"]');
          const re = r.querySelector('input[data-field="region"]');
          if (vj && vj !== document.activeElement) vj.value = item.vj || '';
          if (au && au !== document.activeElement) au.value = item.audio || '';
          if (re && re !== document.activeElement) re.value = item.region || '';
          setRowClass(item.num);
        }
      });
      refreshIssueDropdown();
    }

    function syncToFirebase(){
      const dataObj = {};
      mngList.forEach(item => { dataObj[item.num] = { vj:item.vj||'', audio:item.audio||'', region:item.region||'' }; });
      set(ref(db, 'mngData'), dataObj);
    }

    function loadInitialData(){
      onValue(ref(db, 'mngData'), snap => populateFromSnapshot(snap.val()));
      onValue(ref(db, 'mngHistory'), snap => { histories = snap.val() || {}; });
    }

    // ==== Issue page ====
    function buildIssueDropdown(all=true){
      if (!issueMngSel) return;
      issueMngSel.innerHTML = '<option value="" disabled selected>ì„ íƒ</option>';
      MNG_NUMBERS.forEach(n=>{
        const label = `MNG-${String(n).padStart(2,'0')}`;
        if (!all){
          const item = mngList.find(m=>m.num===label);
          if (item && isUsed(item)) return; // exclude used
        }
        const opt = document.createElement('option');
        opt.value = label; opt.textContent = label;
        issueMngSel.appendChild(opt);
      });
    }
    function refreshIssueDropdown(){ buildIssueDropdown(false); }
    function hydrateIssuePreview(){ if (issueIssuer) issueIssuer.value = currentUserName || ''; }

    window.submitIssue = async function(){
      const mng = issueMngSel.value;
      const user = issueUser.value.trim();
      const region = issueRegion.value.trim();
      if (!mng){ alert('MNGë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      if (!user){ alert('ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      if (!region){ alert('ìœ„ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      await appendHistory(mng, { vj:user, audio: currentUserName || '', region, issuedAt: new Date().toISOString() });
      await set(ref(db, `mngData/${mng}`), { vj:user, audio: currentUserName || '', region });
      alert('ë¶ˆì¶œ ë˜ì—ˆìŠµë‹ˆë‹¤!');
      issueUser.value = ''; issueRegion.value = '';
      refreshIssueDropdown(); // ë°©ê¸ˆ ë¶ˆì¶œëœ í•­ëª© ì œê±°
    };

    // ==== Login & routing ====
    const loginPage = document.getElementById('login-page');
    const statusPage = document.getElementById('status-page');
    const issuePage = document.getElementById('issue-page');
    const codeInput = document.getElementById('login-code');

    window.chooseMode = function(mode){ intendedMode = mode; };

    function login(){
      const code = codeInput.value.trim();
      if (CODE_TO_USER[code]){
        currentUserName = CODE_TO_USER[code];
        loginPage.style.display = 'none';
        if (intendedMode === 'issue'){
          issuePage.style.display = 'block';
          buildIssueDropdown(false);
          hydrateIssuePreview();
          loadInitialData(); // keep in sync even on issue page
        }else{
          statusPage.style.display = 'block';
          buildTableOnce();
          loadInitialData();
          setInterval(syncToFirebase, 5000); // 5s autosave (changed from 10s)
        }
      }else{
        alert('ì˜ëª»ëœ ë¡œê·¸ì¸ ì½”ë“œì…ë‹ˆë‹¤.');
      }
    }

    window.toLogin = function(){
      statusPage.style.display = 'none';
      issuePage.style.display = 'none';
      loginPage.style.display = 'block';
    };

    document.getElementById('btn-login-status').addEventListener('click', ()=>{ chooseMode('status'); login(); });
    document.getElementById('btn-login-issue').addEventListener('click', ()=>{ chooseMode('issue'); login(); });
    codeInput.addEventListener('keydown', e=>{ if (e.key==='Enter'){ login(); } });
  </script>

  <style>
    :root{
      --brand:#1477C9;         /* ë¡œê³  ë¸”ë£¨ ê³„ì—´ */
      --brand-soft:#E7F1FB;
      --ink:#0F172A;
      --muted:#5B6C80;
      --line:#E6EBF2;
      --bg:#F6F9FD;
      --card:#FFFFFF;
      --success:#16A34A;
      --idle:#A2AFC3;
      --radius:16px;
      --shadow:0 10px 30px rgba(20,119,201,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Nanum Barun Gothic',system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      background:var(--bg);
      color:var(--ink);
      margin:0;
      padding:16px;
      -webkit-font-smoothing:antialiased;
      -webkit-tap-highlight-color:transparent;
    }
    img.logo{
      cursor:pointer;
      max-width:360px;
      width:min(58%, 360px);
      display:block;
      margin:18px auto 12px;
    }

    /* Login */
    #login-page,#status-page,#issue-page{display:none}
    #login-page.active{display:block}
    .login-card{
      max-width:520px; margin:0 auto; background:var(--card);
      padding:22px; border-radius:20px; box-shadow:var(--shadow);
      border:1px solid var(--line);
    }
    .login-grid{display:grid; grid-template-columns:1fr; gap:12px}
    .login-actions{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    input[type="password"], input[type="text"], select{
      width:100%; padding:12px 14px;
      border:1px solid var(--line); border-radius:12px; font-size:16px; background:#fff; outline:none;
    }
    input:focus, select:focus{ border-color:var(--brand); box-shadow:0 0 0 4px rgba(20,119,201,.15); }
    .btn{ padding:12px 14px; border:none; border-radius:12px; cursor:pointer; font-weight:700;
      background:var(--brand); color:#fff; box-shadow:var(--shadow); }
    .btn.secondary{background:#fff; color:var(--brand); border:1px solid var(--brand)}
    .login-footer{margin-top:6px; text-align:center; color:var(--muted); font-weight:700}
    .emoji{font-size:16px}

    .container{max-width:1200px; margin:0 auto; padding:8px}

    /* Status table */
    .table-wrap{ background:var(--card); border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); overflow:hidden;}
    table{width:100%; border-collapse:collapse; table-layout:fixed}
    thead th{
      background:linear-gradient(180deg, var(--brand-soft), #F3F8FF);
      color:#133559; font-weight:800; font-size:14px; letter-spacing:.2px;
      text-align:left; padding:10px 12px; border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:2;
    }
    thead th:first-child{width:110px}
    thead th:nth-child(2), thead th:nth-child(3), thead th:nth-child(4){width:28%}
    thead th:last-child{width:90px; text-align:center}

    tbody tr{border-bottom:1px solid var(--line); background:#fff}
    tbody tr.used td.left-stamp{border-left:6px solid var(--success)}
    tbody tr.unused td.left-stamp{border-left:6px solid #CBD5E1}
    tbody td{padding:8px 10px; vertical-align:middle}
    tbody td:last-child{text-align:center}

    .chip{ display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; font-weight:800; font-size:13px; border:1px solid var(--line); background:#fff; cursor:pointer; }
    .chip-used{ border-color:rgba(22,163,74,.45); background:linear-gradient(180deg,#E7F7EE,#F3FBF6); color:#065F46}
    .chip-idle{ border-color:#E5E7EB; background:#F8FAFC; color:#334155}

    input[type="text"]{ width:100%; padding:10px 12px; border:1px solid #D7DFEA; border-radius:12px; font-size:14px; outline:none; background:#fff; }
    input[type="text"]::placeholder{color:#9DA8B8}
    input[type="text"]:focus{ border-color:var(--brand); box-shadow:0 0 0 4px rgba(20,119,201,.12); }

    .reset{ width:38px; height:38px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; background:#FEE2E2; color:#B91C1C; border:1px solid #FCA5A5; cursor:pointer; }
    @media (max-width:720px){
      body{padding:10px}
      thead th{font-size:13px; padding:9px 10px}
      tbody td{padding:7px 8px}
      .chip{font-size:12px; padding:5px 8px}
      .reset{width:32px; height:32px}
    }

    /* Issue page (clean card style like the sample) */
    .issue-card{ max-width:560px; margin:0 auto; background:var(--card); border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); padding:18px; display:grid; gap:12px;}
    .issue-row{display:grid; gap:8px}
    .issue-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .issue-submit{display:block}
    .btn-issue{ width:100%; padding:12px 14px; border:none; border-radius:12px; cursor:pointer; font-weight:600; background:linear-gradient(180deg, #1e6fd1, #1159b2); color:#fff; box-shadow:var(--shadow); }
    .tag{ display:none; } /* 'ë¶ˆì¶œ ë“±ë¡' íƒœê·¸ ìˆ¨ê¹€ */
  

/* === Mobile compact mode === */
@media (max-width: 480px){
  :root{
    --font-base: 12px;
    --font-sm: 11px;
    --pad: 6px;
    --rad: 12px;
  }
  body{ font-size: var(--font-base); }
  .container{ padding: 10px; }
  table{ font-size: var(--font-base); }
  th, td{ padding: 6px 8px; }
  thead th{ font-size: 12px; }
  .chip{ padding: 6px 10px; font-size: 12px; border-radius: 14px; }
  input[type="text"]{
    height: 32px; padding: 4px 8px; font-size: 12px; border-radius: 10px;
    min-width: 4ch; /* Ensure space for ~4 characters */
  }
  .reset{
    width: 36px; height: 36px; min-width: 36px; min-height: 36px;
    font-size: 14px; border-radius: 50%;
  }
  .header{ padding: 8px 0 2px; }
  .logo{ height: 26px; }
  .table-wrap{ border-radius: 14px; }
  .issue-card{ padding: 12px; gap: 8px; }
  .issue-grid{ grid-template-columns: 1fr 1fr; gap: 8px; }
  .btn-issue{ padding: 10px 12px; font-size: 13px; border-radius: 12px; }
}



/* stretch inputs to cell width */
td input[type="text"]{
  width: 100%;
  box-sizing: border-box;
}


@media (max-width: 480px){
  td:nth-child(2), td:nth-child(3), td:nth-child(4){ padding-left:6px; padding-right:6px; }
  td:nth-child(1){ width:84px; } /* No. */
  td:nth-child(5){ width:56px; } /* ë°˜ë‚© */
  input[type="text"]{ min-width: 6ch; } /* ensure ~6 characters visible */
}

</style>
</head>
<body>
  <!-- Login -->
  <div id="login-page" class="active">
    <img src="title_logo.png" class="logo" alt="íƒ€ì´í‹€ ë¡œê³ ">
    <div class="login-card">
      <div class="login-grid">
        <input id="login-code" type="password" placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <div class="login-actions">
          <button id="btn-login-status" class="btn">í˜„í™©</button>
          <button id="btn-login-issue" class="btn secondary">ë¶ˆì¶œ</button>
        </div>
        <div class="login-footer">MNG í˜„í™© ìµœì‹ í™” ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤ <span class="emoji">ğŸ“¡</span></div>
      </div>
    </div>
  </div>

  <!-- Status Page -->
  <div id="status-page">
    <img src="title_logo.png" class="logo" alt="íƒ€ì´í‹€ ë¡œê³ " onclick="toLogin()">
    <div class="container">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>No.</th>
              <th>ì‚¬ìš©ì</th>
              <th>ë¶ˆì¶œì</th>
              <th>ìœ„ì¹˜</th>
              <th>ë°˜ë‚©</th>
            </tr>
          </thead>
          <tbody id="mng-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Issue Page -->
  <div id="issue-page">
    <img src="title_logo.png" class="logo" alt="íƒ€ì´í‹€ ë¡œê³ " onclick="toLogin()">
    <div class="issue-card">
      <div class="issue-row">
        <label for="issue-mng" style="font-weight:800">MNG ì„ íƒ</label>
        <select id="issue-mng"></select>
      </div>
      <div class="issue-grid">
        <div class="issue-row">
          <label style="font-weight:800">ì‚¬ìš©ì</label>
          <input id="issue-user" type="text" placeholder="ì´ë¦„">
        </div>
        <div class="issue-row">
          <label style="font-weight:800">ë¶ˆì¶œì</label>
          <input id="issue-issuer" type="text" placeholder="ìë™ ì…ë ¥" disabled>
        </div>
      </div>
      <div class="issue-row">
        <label style="font-weight:800">ìœ„ì¹˜</label>
        <input id="issue-region" type="text" placeholder="ì˜ˆ: ê°•ë‚¨">
      </div>
      <div class="issue-submit">
        <button class="btn-issue" onclick="submitIssue()">ë¶ˆì¶œ</button>
      </div>
    </div>
  </div>
</body>
</html>
