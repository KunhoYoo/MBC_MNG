<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MNG ÌòÑÌô©Ìåê</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Barun+Gothic&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#1477C9; --brand-soft:#E7F1FB; --ink:#0F172A; --muted:#5B6C80;
      --line:#E6EBF2; --bg:#F6F9FD; --card:#FFFFFF; --success:#16A34A;
      --shadow:0 10px 30px rgba(20,119,201,.08); --control-h:48px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{font-family:'Nanum Barun Gothic',system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    img.logo{cursor:pointer;max-width:360px;width:min(58%,360px);display:block;margin:10px auto 3px}
    #login-page,#status-page,#issue-page{display:none;width:100%}
    #login-page.active{display:flex} .screen{width:100%}
    .container{max-width:1200px;margin:0 auto;padding:16px;position:relative}
    #login-page{min-height:100vh;align-items:center;justify-content:center;flex-direction:column;padding:24px}
    .login-card{width:min(680px,92vw);background:var(--card);padding:22px;border-radius:20px;box-shadow:var(--shadow);border:1px solid var(--line)}
    .login-grid{display:grid;grid-template-columns:1fr;gap:12px}
    .login-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{width:100%;height:var(--control-h);padding:0 16px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff;outline:none}
    input.field:focus,select.field:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(20,119,201,.15)}
    select.field{appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:linear-gradient(45deg,transparent 50%,#8593a6 50%),linear-gradient(135deg,#8593a6 50%,transparent 50%);background-position:calc(100% - 20px) calc(50% - 3px),calc(100% - 15px) calc(50% - 3px);background-size:8px 8px,8px 8px;background-repeat:no-repeat}
    .btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:700;background:var(--brand);color:#fff;box-shadow:var(--shadow)}
    .btn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .btn.small{padding:10px 12px;font-size:14px;border-radius:10px}
    .btn.danger{background:#ef4444;color:#fff;border:1px solid #ef4444}
    .btn.danger:hover{filter:brightness(.95)}
    .login-footer{margin-top:6px;text-align:center;color:var(--muted);font-weight:700}
    .tables-grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:1024px){.tables-grid{grid-template-columns:1fr 1fr}}
    @media (max-width:1023px){.table-wrap.right{display:none}}
    .table-wrap{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{background:linear-gradient(180deg,var(--brand-soft),#F3F8FF);color:#133559;font-weight:800;font-size:14px;letter-spacing:.2px;text-align:left;padding:10px 12px;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:2;white-space:nowrap}
    thead th:first-child{width:110px}
    thead th:nth-child(2),thead th:nth-child(3),thead th:nth-child(4){width:28%}
    thead th:last-child{width:90px;text-align:center}
    tbody tr{border-bottom:1px solid var(--line);background:#fff}
    tbody tr.used td.left-stamp{border-left:6px solid var(--success)}
    tbody tr.unused td.left-stamp{border-left:6px solid #CBD5E1}
    tbody td{padding:8px 10px;vertical-align:middle}
    tbody td:last-child{text-align:center}
    .chip{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .chip-used{border-color:rgba(22,163,74,.45);background:linear-gradient(180deg,#E7F7EE,#F3FBF6);color:#065F46}
    .chip-idle{border-color:#E5E7EB;background:#F8FAFC;color:#334155}
    input[type="text"]{width:100%;height:38px;padding:0 12px;border:1px solid #D7DFEA;border-radius:12px;font-size:14px;outline:none;background:#fff}
    input[type="text"]::placeholder{color:#9DA8B8}
    input[type="text"]:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(20,119,201,.12)}
    .reset{width:38px;height:38px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;background:#FEE2E2;color:#B91C1C;border:1px solid #FCA5A5;cursor:pointer}
    @media (max-width:720px){.container{padding:10px} thead th{font-size:13px;padding:9px 10px} tbody td{padding:7px 8px} .chip{font-size:12px;padding:5px 8px} .reset{width:32px;height:32px} input[type="text"]{height:34px}}
    @media (max-width:480px){thead th{font-size:12px} th,td{padding-left:6px;padding-right:6px} td:nth-child(1){width:84px} td:nth-child(5){width:56px} input[type="text"]{height:32px;font-size:12px;padding:0 8px;border-radius:10px} .chip{padding:5px 8px;font-size:12px} .reset{width:34px;height:34px;min-width:34px;min-height:34px}}
    .issue-card{max-width:560px;margin:24px auto;background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:18px;display:grid;gap:12px}
    .issue-row{display:grid;gap:8px}
    .issue-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .issue-submit{display:block}
    .btn-issue{width:100%;padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:600;background:linear-gradient(180deg,#1e6fd1,#1159b2);color:#fff;box-shadow:var(--shadow)}
    #status-page table thead th { text-align: center; }
    .top-actions{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:8px}
    .top-times{display:none;flex-direction:column;align-items:flex-start;color:#335; font-weight:700;}
    .top-times .time{font-size:14px;white-space:nowrap;margin-bottom:4px;}
    .top-times .label{color:#5B6C80;font-weight:800;margin-right:6px}
    @media (min-width:1024px){ .top-times{display:flex} }
    .toasts{position:fixed; right:20px; bottom:20px; z-index:9999; display:flex; flex-direction:column; align-items:flex-end; gap:10px; max-width:calc(100vw - 40px);}
    .toast{background:#13253a; color:#fff; border-radius:14px; padding:14px 16px; box-shadow:0 18px 40px rgba(0,0,0,.22); display:flex; align-items:flex-start; gap:10px; min-width:260px; max-width:360px; opacity:0; transform:translateY(10px) scale(.98); animation:toast-in .25s ease forwards;}
    .toast .dot{width:14px;height:14px;border-radius:999px;margin-top:4px;flex:none}
    .toast.issue .dot{background:#10B981}
    .toast.return .dot{background:#3B82F6}
    .toast .title{font-weight:800;margin:0 0 4px 0}
    .toast .desc{margin:0;color:#E6EDF6;font-size:14px;line-height:1.35}
    .toast-close{margin-left:auto;background:transparent;border:none;color:#9fb4cc;font-weight:800;cursor:pointer}
    @keyframes toast-in{to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes toast-out{to{opacity:0;transform:translateY(10px) scale(.98)}}
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;z-index:9998}
    .modal[aria-hidden="false"]{display:flex}
    .modal-card{width:min(720px,92vw);max-height:min(80vh,840px);overflow:auto;background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:var(--shadow);padding:16px;display:grid;gap:12px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal-title{font-weight:800;font-size:18px;color:#0b2b52}
    .log-list{display:grid;gap:8px}
    .log-item{padding:10px 12px;border:1px solid #E6EBF2;border-radius:12px;background:#F8FAFF}
    .log-meta{font-size:12px;color:#5B6C80}
    .btn-row{display:flex;justify-content:flex-end;gap:8px}
    #btn-log { background-color: #f4f8fc; color: #1477C9; border-color: #c5ddf3; }
    #btn-log:hover { background-color: #e9f2fa; }
    .top-actions { margin-top: -20px; margin-bottom: 8px; }
    img.logo { margin-bottom: 0; }
    .container { padding-top: 0; }
  </style>
</head>
<body>
  <div id="login-page" class="screen active">
    <img src="title_logo.png" class="logo" alt="ÌÉÄÏù¥ÌãÄ Î°úÍ≥†" onclick="toLogin()">
    <div class="login-card">
      <div class="login-grid">
        <input id="login-code" type="password" class="field" placeholder="ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" autocomplete="current-password" inputmode="text">
        <div class="login-actions">
          <button id="btn-login-status" class="btn" type="button">ÌòÑÌô©</button>
          <button id="btn-login-issue" class="btn secondary" type="button">Î∂àÏ∂ú</button>
        </div>
        <div class="login-footer">MNG ÌòÑÌô© ÏµúÏã†Ìôî Ïûò Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§ üì°</div>
      </div>
    </div>
  </div>

  <div id="status-page" class="screen">
    <img src="title_logo.png" class="logo" alt="ÌÉÄÏù¥ÌãÄ Î°úÍ≥†" onclick="toLogin()">
    <div class="container">
      <div class="top-actions">
        <div class="top-times" aria-live="polite">
          <div class="time"><span class="label">ÌòÑÏû¨ÏãúÍ∞Ñ</span><span id="now-time">-</span></div>
          <div class="time"><span class="label">ÏóÖÎç∞Ïù¥Ìä∏</span><span id="update-time">-</span></div>
        </div>
        <button id="btn-log" class="btn secondary small" type="button" title="ÏµúÍ∑º Í∏∞Î°ù Î≥¥Í∏∞">Log</button>
      </div>
      <div class="tables-grid">
        <div class="table-wrap left">
          <table>
            <thead><tr><th>No.</th><th>ÏÇ¨Ïö©Ïûê</th><th>Î∂àÏ∂úÏûê</th><th>ÏúÑÏπò</th><th>Î∞òÎÇ©</th></tr></thead>
            <tbody id="mng-left"></tbody>
          </table>
        </div>
        <div class="table-wrap right">
          <table>
            <thead><tr><th>No.</th><th>ÏÇ¨Ïö©Ïûê</th><th>Î∂àÏ∂úÏûê</th><th>ÏúÑÏπò</th><th>Î∞òÎÇ©</th></tr></thead>
            <tbody id="mng-right"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="issue-page" class="screen">
    <img src="title_logo.png" class="logo" alt="ÌÉÄÏù¥ÌãÄ Î°úÍ≥†" onclick="toLogin()">
    <div class="issue-card">
      <div class="issue-row">
        <label for="issue-mng" style="font-weight:800">MNG ÏÑ†ÌÉù</label>
        <select id="issue-mng" class="field"></select>
      </div>
      <div class="issue-grid">
        <div class="issue-row">
          <label style="font-weight:800">ÏÇ¨Ïö©Ïûê</label>
          <input id="issue-user" type="text" class="field" placeholder="Ïù¥Î¶Ñ">
        </div>
        <div class="issue-row">
          <label style="font-weight:800">Î∂àÏ∂úÏûê</label>
          <input id="issue-issuer" type="text" class="field" placeholder="ÏûêÎèô ÏûÖÎ†•" disabled>
        </div>
      </div>
      <div class="issue-row">
        <label style="font-weight:800">ÏúÑÏπò</label>
        <input id="issue-region" type="text" class="field" placeholder="Ïòà: Í∞ïÎÇ®">
      </div>
      <div class="issue-submit">
        <button id="btn-issue-submit" class="btn-issue" type="button">Î∂àÏ∂ú</button>
      </div>
    </div>
  </div>

  <div id="log-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="log-title">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="log-title">ÏµúÍ∑º 20Í∞ú Í∏∞Î°ù</div>
        <button id="btn-log-close" class="btn secondary small" type="button" aria-label="Îã´Í∏∞">Îã´Í∏∞</button>
      </div>
      <div id="log-list" class="log-list" aria-live="polite"></div>
      <div class="btn-row">
        <button id="btn-log-clear" class="btn small danger" type="button">Log Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>
        <button id="btn-log-download" class="btn small" type="button">ÌÖçÏä§Ìä∏ Îã§Ïö¥Î°úÎìú</button>
      </div>
    </div>
  </div>

  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>
  <audio id="alarm-audio" src="alarm.mp3" preload="auto"></audio>

  <script>
    (function(){
      const CODE_TO_USER = {"dbrjsgh":"Ïú†Í±¥Ìò∏","rlawnsgml":"ÍπÄÏ§ÄÌù¨","dlwlgns":"Ïù¥ÏßÄÌõà","gkstldn":"ÌïúÏãúÏö∞","didtmdghks":"ÏñëÏäπÌôò","wjseowns":"Ï†ÑÎåÄÏ§Ä","dlgmdfyd":"Ïù¥Ìù•Î£°","tlscjfdks":"Ïã†Ï≤†Ïïà","wlstkdgns":"ÏßÑÏÉÅÌõà","rlaxogy":"ÍπÄÌÉúÌö®","dlwhdgur":"Ïù¥Ï¢ÖÌòÅ","rlatmdals":"ÍπÄÏäπÎØº","dlwlsgks":"Ïù¥ÏßÑÌïú","rlawodnd":"ÍπÄÏû¨ÏõÖ","didguswls":"ÏñëÌòÑÏßÑ","fbtmdgh":"Î•òÏäπÌò∏","vuswoghks":"Ìé∏Ïû¨Ìôò","rlaalswns":"ÍπÄÎØºÏ§Ä","wjdgnldyd":"Ï†ïÌúòÏö©","wjdwlgur":"Ï†ïÏßÄÌòÅ","rladudwls":"ÍπÄÏòÅÏßÑ","rlawotmd":"ÍπÄÏû¨Ïäπ","rlaxowns":"ÍπÄÌÉúÏ§Ä","qorcksgus":"Î∞±Ï∞¨ÌòÑ","dlgusdyd":"Ïù¥ÌòÑÏö©","tlaalswns":"Ïã¨ÎØºÏ§Ä","qkrwndud":"Î∞ïÏ£ºÏòÅ","dlwogk":"Ïù¥Ïû¨Ìïò","dlalstkd":"Ïù¥ÎØºÏÉÅ","ckalsdnr":"Ï∞®ÎØºÏö±","rlawhddns":"ÍπÄÏ¢ÖÏö¥","dksghdcks":"ÏïàÌôçÏ∞¨","qkrwogud":"Î∞ïÏû¨Ìòï","dydalswnd":"Ïö©ÎØºÏ§ë","dbstjrwns":"Ïú§ÏÑùÏ§Ä","quswnsgml":"Î≥ÄÏ§ÄÌù¨","qkrgustn":"Î∞ïÌòÑÏàò","rnjsehddh":"Í∂åÎèôÏò§","ghdtjddh":"ÌôçÏÑ±Ïò§","rlarudgus":"ÍπÄÍ≤ΩÌòÑ","rnjswlsaud":"Í∂åÏßÑÎ™Ö","dlghkswns":"Ïù¥ÌôòÏ§Ä","didguswns":"ÏñëÌòÑÏ§Ä","dlgkswns":"Ïù¥ÌïúÏ§Ä","tlswpdyd":"Ïã†Ï†úÏö©","wkdtpdnjs":"Ï†ïÏÑ∏Ïõê","rlaalsrb":"ÍπÄÎØºÍ∑ú","dldPeh":"Ïù¥ÏòàÎèÑ","qkralscks":"Î∞ïÎØºÏ∞¨","rlathdgus":"ÍπÄÏÜ°ÌòÑ","qkrwjdejr":"Î∞ïÏ†ïÎçï","wkdwodms":"Ïû•Ïû¨ÏùÄ","wkddudrms":"Ïû•ÏòÅÍ∑º"};
      const mapLower = Object.fromEntries(Object.entries(CODE_TO_USER).map(([k,v])=>[k.toLowerCase(), v]));
      function getUserByCode(code){ if(!code) return null; return mapLower[String(code).toLowerCase()] || null; }

      const MNG_NUMBERS = [1,2,3,4,5,6,7,8,9,10,17,18,19,20,21,22,23,24,25,26];
      const mngList = MNG_NUMBERS.map(n=>({ num:`MNG-${String(n).padStart(2,'0')}`, vj:'', audio:'', region:'' }));
      let histories = {}; let allLogs = []; const LOG_LIMIT = 500; const RECENT_SHOW = 20;
      let currentUserName = ""; let intendedMode = "status"; let listenersAttached = false; let dataListenersStarted = false; let syncTimer = null; let firebaseReady = false; let DB = null;

      // ÏãúÍ∞Ñ ÌëúÏãú(PC Ï†ÑÏö©)
      let lastUpdateTs = 0;
      const $now = () => document.getElementById('now-time');
      const $upd = () => document.getElementById('update-time');
      const DOW_KR = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
      const p = (x)=>String(x).padStart(2,'0');
      function kstNow(){ const now = new Date(); const kstString = now.toLocaleString('en-US',{ timeZone:'Asia/Seoul' }); return new Date(kstString); }
      function formatKRFull(dt){ const y=dt.getFullYear(), m=p(dt.getMonth()+1), d=p(dt.getDate()); const hh=p(dt.getHours()), mm=p(dt.getMinutes()), ss=p(dt.getSeconds()); const wd = DOW_KR[dt.getDay()]; return `${y}-${m}-${d}(${wd}) ${hh}:${mm}:${ss}`; }
      function renderTimes(){ const n=$now(); if(n){ n.textContent = formatKRFull(kstNow()); } const u=$upd(); if(u){ u.textContent = lastUpdateTs ? formatKRFull(new Date(lastUpdateTs)) : '-'; } }
      setInterval(renderTimes, 1000);

      const TOAST_LIFETIME = 6000; let lastSeen = { issue: 0, ret: 0 };
      function playAlarm(){ try{ const a = new Audio(document.getElementById('alarm-audio').src); a.volume=1.0; a.play().catch(()=>{});}catch(e){} }
      function showToast(kind, title, desc){
        const t = document.createElement('div'); t.className = `toast ${kind}`;
        t.innerHTML = `<div class="dot"></div><div style="flex:1 1 auto"><div class="title">${title}</div><p class="desc">${desc}</p></div><button class="toast-close" aria-label="Îã´Í∏∞">√ó</button>`;
        const stack=document.getElementById('toasts'); stack && stack.prepend(t);
        const closer=t.querySelector('.toast-close'); const remove=()=>{ t.style.animation='toast-out .2s ease forwards'; setTimeout(()=>t.remove(),200); };
        closer && closer.addEventListener('click', remove); playAlarm(); setTimeout(remove, TOAST_LIFETIME);
      }

      function isUsed(item){ return Boolean((item.vj||'').trim() || (item.audio||'').trim() || (item.region||'').trim()); }
      function rowEl(num){ return document.querySelector(`tr[data-num="${num}"]`); }
      function setRowClass(num){ const item=mngList.find(m=>m.num===num); const r=rowEl(num); if(!r||!item) return; r.classList.toggle('used', isUsed(item)); r.classList.toggle('unused', !isUsed(item)); const chip=r.querySelector('.chip'); if(chip){ chip.classList.toggle('chip-used', isUsed(item)); chip.classList.toggle('chip-idle', !isUsed(item)); } }

      function toLogin(){ document.getElementById('status-page').style.display='none'; document.getElementById('issue-page').style.display='none'; const lp=document.getElementById('login-page'); lp.style.display='flex'; lp.classList.add('active'); window.scrollTo({top:0,behavior:'auto'}); }
      window.toLogin = toLogin;

      function buildTableOnce(){
        const tbodyLeft=document.getElementById('mng-left'); const tbodyRight=document.getElementById('mng-right'); if(!tbodyLeft||!tbodyRight) return;
        tbodyLeft.innerHTML=''; tbodyRight.innerHTML=''; const isMobile=window.matchMedia('(max-width:1023px)').matches;
        mngList.forEach((item,idx)=>{
          const tr=document.createElement('tr'); tr.dataset.num=item.num; tr.className=isUsed(item)?'used':'unused';
          tr.innerHTML=`<td class="left-stamp"><button class="chip ${isUsed(item)?'chip-used':'chip-idle'}" data-history="${item.num}">${item.num}</button></td>
            <td><input type="text" data-field="vj" placeholder="Ïù¥Î¶Ñ" value="${item.vj||''}"></td>
            <td><input type="text" data-field="audio" placeholder="Ïù¥Î¶Ñ" value="${item.audio||''}"></td>
            <td><input type="text" data-field="region" placeholder="Ïòà: Í∞ïÎÇ®" value="${item.region||''}"></td>
            <td class="action-cell"><button class="reset" data-reset="${item.num}" title="Î∞òÎÇ©(Ï¥àÍ∏∞Ìôî)" aria-label="Î∞òÎÇ©">‚ü≤</button></td>`;
          (isMobile || idx<10 ? tbodyLeft : tbodyRight).appendChild(tr);
        });
        if(!listenersAttached){
          [tbodyLeft,tbodyRight].forEach(tbody=>{
            tbody.addEventListener('input',e=>{
              const inp=e.target.closest('input[data-field]'); if(!inp) return;
              const tr=e.target.closest('tr'); if(!tr) return; const num=tr.dataset.num; const field=inp.dataset.field; const item=mngList.find(m=>m.num===num); if(!item) return;
              item[field]=inp.value; setRowClass(num); refreshIssueDropdown();
            });
            tbody.addEventListener('click',async e=>{
              const resetBtn=e.target.closest('button[data-reset]');
              if(resetBtn){
                const num=resetBtn.dataset.reset; const item=mngList.find(m=>m.num===num); if(!item) return;
                if(!confirm('Ìï¥Îãπ MNG Î∞òÎÇ©Ï≤òÎ¶¨ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                if(isUsed(item)){ await appendHistory(num,{ vj:item.vj||'', audio:item.audio||'', region:item.region||'', returnedAt:new Date().toISOString() }); }
                const prev={ vj:item.vj||'', audio:item.audio||'', region:item.region||'' };
                item.vj=item.audio=item.region=''; const tr=rowEl(num); if(tr){ tr.querySelectorAll('input').forEach(i=>i.value=''); } setRowClass(num);
                const nowTs=Date.now();
                if(firebaseReady){
                  await DB.setData(`mngData/${num}`, { vj:'', audio:'', region:'' });
                  await DB.setData('lastReturn', { mng:num, user:'-', region:'-', returnedBy: currentUserName || '(ÏïåÏàòÏóÜÏùå)', ts: nowTs });
                  const newLog={ type:'return', mng:num, user:prev.vj||'-', region:prev.region||'-', by: currentUserName || '(ÏïåÏàòÏóÜÏùå)', ts: nowTs };
                  const updated=[newLog, ...(allLogs||[])].slice(0, LOG_LIMIT); allLogs=updated; await DB.setData('globalLog', updated);
                }
                refreshIssueDropdown(); return;
              }
              const histBtn=e.target.closest('button[data-history]');
              if(histBtn){
                const num=histBtn.dataset.history; const arr=histories && histories[num] ? histories[num] : [];
                if(!arr.length){ alert(`<${num} Í≥ºÍ±∞ Í∏∞Î°ù>\\nÍ∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.`); return; }
                const safeTime = ts => { if(!ts) return '-'; const d=new Date(ts); return isNaN(d)?'-':`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}Ïãú${p(d.getMinutes())}Î∂Ñ`; };
                const lines = arr.map(e => { const ts=e.returnedAt||e.issuedAt; const action=e.returnedAt?'Î∞òÎÇ©':(e.issuedAt?'Î∂àÏ∂ú':''); return `${e.vj||'-'} / ${e.audio||'-'} / ${e.region||'-'} / ${safeTime(ts)} ${action}`; });
                alert(`<${num} Í≥ºÍ±∞ Í∏∞Î°ù>\n` + lines.join('\n'));
              }
            });
          });
          listenersAttached=true;
        }
      }

      function populateFromSnapshot(data){
        mngList.forEach(item=>{
          if(data && data[item.num]){ Object.assign(item, data[item.num]); }
          const r=rowEl(item.num); if(!r) return;
          const vj=r.querySelector('input[data-field="vj"]'); const au=r.querySelector('input[data-field="audio"]'); const re=r.querySelector('input[data-field="region"]');
          if(vj && vj!==document.activeElement) vj.value=item.vj||'';
          if(au && au!==document.activeElement) au.value=item.audio||'';
          if(re && re!==document.activeElement) re.value=item.region||'';
          setRowClass(item.num);
        });
        refreshIssueDropdown();
      }

      function buildIssueDropdown(all=true){
        const sel=document.getElementById('issue-mng'); if(!sel) return;
        sel.innerHTML='<option value="" disabled selected>ÏÑ†ÌÉù</option>';
        MNG_NUMBERS.forEach(n=>{
          const label=`MNG-${String(n).padStart(2,'0')}`;
          if(!all){ const item=mngList.find(m=>m.num===label); if(item && isUsed(item)) return; }
          const opt=document.createElement('option'); opt.value=label; opt.textContent=label; sel.appendChild(opt);
        });
      }
      function refreshIssueDropdown(){ buildIssueDropdown(false); }

      async function appendHistory(num, entry){ const arr=histories[num] ? [...histories[num]] : []; arr.unshift(entry); histories[num]=arr.slice(0,5); if(firebaseReady){ await DB.setData(`mngHistory/${num}`, histories[num]); } }

      async function submitIssue(){
        const sel=document.getElementById('issue-mng'); const userEl=document.getElementById('issue-user'); const regionEl=document.getElementById('issue-region');
        if(!sel) return; const mng=sel.value; const user=(userEl?.value||'').trim(); const region=(regionEl?.value||'').trim();
        if(!mng){ alert('MNGÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'); return; } if(!user){ alert('ÏÇ¨Ïö©Ïûê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; } if(!region){ alert('ÏúÑÏπòÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }
        await appendHistory(mng,{ vj:user, audio: currentUserName || '', region, issuedAt:new Date().toISOString() });
        const nowTs=Date.now();
        if(firebaseReady){
          await DB.setData(`mngData/${mng}`, { vj:user, audio: currentUserName || '', region });
          await DB.setData('lastIssue', { mng, user, region, issuedBy: currentUserName || '(ÏïåÏàòÏóÜÏùå)', ts: nowTs });
          const newLog={ type:'issue', mng, user, region, by: currentUserName || '(ÏïåÏàòÏóÜÏùå)', ts: nowTs };
          const updated=[newLog, ...(allLogs||[])].slice(0, LOG_LIMIT); allLogs=updated; await DB.setData('globalLog', updated);
        }
        alert('Î∂àÏ∂ú ÎêòÏóàÏäµÎãàÎã§!'); if(userEl) userEl.value=''; if(regionEl) regionEl.value=''; refreshIssueDropdown();
      }

      function showScreen(id){ const lp=document.getElementById('login-page'); const sp=document.getElementById('status-page'); const ip=document.getElementById('issue-page');
        lp.style.display = id==='login' ? 'flex':'none'; sp.style.display = id==='status' ? 'block':'none'; ip.style.display = id==='issue' ? 'block':'none';
        if(id==='login'){ lp.classList.add('active'); } window.scrollTo({top:0,behavior:'auto'});
      }
      function safeBind(id,event,handler){ const el=document.getElementById(id); if(el) el.addEventListener(event, handler, { passive:false }); }
      function attachLoginHandlers(){
        const codeInput=document.getElementById('login-code'); const btnStatus=document.getElementById('btn-login-status'); const btnIssue=document.getElementById('btn-login-issue'); const btnIssueSubmit=document.getElementById('btn-issue-submit');
        safeBind('btn-log','click', openLogModal);
        function chooseMode(m){ intendedMode=m; }
        function login(){
          const code=(codeInput?.value||'').trim(); const name=getUserByCode(code);
          if(name){ currentUserName=name;
            if(intendedMode==='issue'){ showScreen('issue'); buildIssueDropdown(false); const issuer=document.getElementById('issue-issuer'); if(issuer) issuer.value=currentUserName||''; if(firebaseReady && !dataListenersStarted){ DB.startListeners(); } }
            else{ showScreen('status'); buildTableOnce(); if(firebaseReady && !dataListenersStarted){ DB.startListeners(); } if(firebaseReady && !syncTimer){ syncTimer=setInterval(()=>DB.syncAll(), 5000); } }
          }else{ alert('ÏûòÎ™ªÎêú Î°úÍ∑∏Ïù∏ ÏΩîÎìúÏûÖÎãàÎã§.'); }
        }
        btnStatus && btnStatus.addEventListener('click', (e)=>{ e.preventDefault(); chooseMode('status'); login(); });
        btnIssue  && btnIssue.addEventListener('click',  (e)=>{ e.preventDefault(); chooseMode('issue');  login(); });
        btnIssueSubmit && btnIssueSubmit.addEventListener('click', submitIssue);
        codeInput && codeInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); chooseMode('status'); login(); } });
      }

      // Log Î™®Îã¨ & Îã§Ïö¥Î°úÎìú & Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
      function renderLogList(){
        const list=document.getElementById('log-list'); if(!list) return; list.innerHTML='';
        const recent=(allLogs||[]).slice(0,RECENT_SHOW);
        if(!recent.length){ const empty=document.createElement('div'); empty.className='log-item'; empty.textContent='ÌëúÏãúÌï† Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.'; list.appendChild(empty); return; }
        for(const e of recent){
          const d=new Date(e.ts||Date.now()); const actionText=e.type==='issue'?'Î∂àÏ∂ú':'Î∞òÎÇ©';
          const item=document.createElement('div'); item.className='log-item';
          item.innerHTML=`<div><b>${e.mng}</b> ¬∑ ${actionText}</div><div class="log-meta">${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}Ïãú${p(d.getMinutes())}Î∂Ñ ¬∑ ÏÇ¨Ïö©Ïûê: ${e.user||'-'} ¬∑ ÏúÑÏπò: ${e.region||'-'} ¬∑ Ï≤òÎ¶¨Ïûê: ${e.by||'-'}</div>`;
          list.appendChild(item);
        }
      }
      function openLogModal(){ const modal=document.getElementById('log-modal'); if(!modal) return; renderLogList(); modal.setAttribute('aria-hidden','false'); }
      function closeLogModal(){ const modal=document.getElementById('log-modal'); if(!modal) return; modal.setAttribute('aria-hidden','true'); }
      async function clearAllLogs(){
        const pw = window.prompt('Log Ï†ÑÏ≤¥ ÏÇ≠Ï†ú ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:\\n(ÏÇ≠Ï†ú ÌõÑ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§)');
        if(pw !== 'mbcmngreset'){
          if(pw !== null) alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
          return;
        }
        try{
          if(firebaseReady && DB){
            await DB.setData('globalLog', []);
            await DB.setData('mngHistory', {});
            await DB.setData('lastIssue', null);
            await DB.setData('lastReturn', null);
          }
          allLogs = [];
          histories = {};
          lastUpdateTs = 0;
          renderTimes();
          renderLogList();
          window.alert('LogÍ∞Ä Î™®Îëê ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }catch(err){
          console.error(err); window.alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
      }
      function buildTxtFromLogs(entries){
        const lines=['# MNG Global Log (ÏµúÏã†Ïàú, ÏµúÎåÄ 500Í∞ú)'];
        for(const e of entries){
          const d=new Date(e.ts||Date.now());
          const p2=n=>String(n).padStart(2,'0');
          const actionText=e.type==='issue'?'Î∂àÏ∂ú':'Î∞òÎÇ©';
          lines.push(`${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())} ${p2(d.getHours())}:${p2(d.getMinutes())}:${p2(d.getSeconds())} | ${e.mng} | ${actionText} | ÏÇ¨Ïö©Ïûê:${e.user||'-'} | ÏúÑÏπò:${e.region||'-'} | Ï≤òÎ¶¨Ïûê:${e.by||'-'}`);
        }
        return lines.join('\\n');
      }
      function downloadLogTxt(){
        const d=kstNow(); const p2=n=>String(n).padStart(2,'0');
        const filename=`${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}_MNG_log.txt`;
        const blob=new Blob([buildTxtFromLogs((allLogs||[]).slice(0,LOG_LIMIT))],{type:'text/plain;charset=utf-8'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      window.addEventListener('DOMContentLoaded',()=>{
        try{
          attachLoginHandlers();
          // Wire modal footer buttons
          const btnClose=document.getElementById('btn-log-close');
          const btnDl=document.getElementById('btn-log-download');
          const btnClr=document.getElementById('btn-log-clear');
          btnClose && btnClose.addEventListener('click', closeLogModal);
          btnDl && btnDl.addEventListener('click', downloadLogTxt);
          btnClr && btnClr.addEventListener('click', clearAllLogs);

          showScreen('login'); buildTableOnce(); renderTimes();
          // Firebase lazy-load
          (async ()=>{
            try{
              const [{ initializeApp }, { getDatabase, ref, set, onValue }] = await Promise.all([
                import('https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js'),
                import('https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js')
              ]);
              const firebaseConfig = { apiKey:"AIzaSyADWorIbKPZZoWx7qAriiCA2lYtf-MSdAA", authDomain:"mbc-mng.firebaseapp.com", databaseURL:"https://mbc-mng-default-rtdb.firebaseio.com", projectId:"mbc-mng", storageBucket:"mbc-mng.firebasestorage.app", messagingSenderId:"845487713315", appId:"1:845487713315:web:d8559559fa98870fde5596" };
              const app = initializeApp(firebaseConfig); const db = getDatabase(app);
              DB = {
                setData:(path,value)=>set(ref(db,path),value),
                startListeners: () => {
                  if(dataListenersStarted) return;
                  const nowTs=Date.now(); if(lastSeen.issue===0 && lastSeen.ret===0){ lastSeen.issue=nowTs; lastSeen.ret=nowTs; }
                  onValue(ref(db,'mngData'), snap => populateFromSnapshot(snap.val()));
                  onValue(ref(db,'mngHistory'), snap => { histories = snap.val() || {}; });
                  onValue(ref(db,'globalLog'), snap => { allLogs = snap.val() || []; if(allLogs.length && allLogs[0].ts){ lastUpdateTs = Math.max(lastUpdateTs, allLogs[0].ts); renderTimes(); } });
                  onValue(ref(db,'lastIssue'), snap => { const v=snap.val(); if(!v) return; if(document.getElementById('status-page').style.display!=='block') return; if(v.ts && v.ts <= lastSeen.issue) return; lastSeen.issue=v.ts||Date.now(); lastUpdateTs=Math.max(lastUpdateTs,lastSeen.issue); renderTimes(); showToast('issue','ÏÉà Î∂àÏ∂ú ÏïåÎ¶º',`${v.issuedBy}ÎãòÏù¥ ${v.mng}Î•º Î∂àÏ∂úÌñàÏäµÎãàÎã§<br>${v.user} / ${v.region}`); });
                  onValue(ref(db,'lastReturn'), snap => { const v=snap.val(); if(!v) return; if(document.getElementById('status-page').style.display!=='block') return; if(v.ts && v.ts <= lastSeen.ret) return; lastSeen.ret=v.ts||Date.now(); lastUpdateTs=Math.max(lastUpdateTs,lastSeen.ret); renderTimes(); showToast('return','Î∞òÎÇ© ÏïåÎ¶º',`${v.returnedBy}ÎãòÏù¥ ${v.mng}Î•º Î∞òÎÇ©ÌñàÏäµÎãàÎã§`); });
                  dataListenersStarted = true;
                },
                syncAll: () => { const obj={}; mngList.forEach(it=>obj[it.num]={ vj:it.vj||'', audio:it.audio||'', region:it.region||'' }); set(ref(db,'mngData'), obj); }
              };
              firebaseReady = true;
            }catch(err){ console.error('Firebase Î°úÎìú Ïã§Ìå®:', err); }
          })();
        }catch(e){ console.error('Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', e); }
      });
    })();
  </script>
</body>
</html>
