<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MBC MNG í˜„í™©íŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Barun+Gothic&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#1477C9; --ink:#0f172a; --bg:#F6F9FD; --card:#ffffff; --line:#E6EBF2;
    --row-h:34px; --gap:6px; --label-w:86px;
    --base:#F3F4F6; --overseas:#E6F7EA; --bureau:#FFF9DB;
    --ret:#ffd6e5; --ret2:#ffc2d9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Nanum Barun Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo','Noto Sans KR', sans-serif}
  .hidden{display:none!important}
  .center{display:flex;align-items:center;justify-content:center}
  .btn{padding:8px 12px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
  .btn.small{padding:6px 10px;border-radius:9px}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-return{display:block;width:92%;height:24px;line-height:24px;margin:3px auto 1px;border-radius:10px;border:1px solid #f4a8bd;background:var(--ret);color:#9a1849;font-weight:700;cursor:pointer;font-size:11px}
  .btn-return:hover{background:var(--ret2)}
  /* ë¡œê·¸ì¸ */
  #login{min-height:100vh;display:flex;align-items:center;justify-content:center}
  .login-card{width:min(560px,94vw);background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(20,119,201,.06);padding:18px}
  .title-logo{max-width:340px;width:min(70%,340px);display:block;margin:4px auto 10px;cursor:pointer}
  .login-row{display:flex;gap:8px;justify-content:center}
  .login-input{width:60%;height:40px;border:1px solid #ccd7e6;border-radius:10px;padding:0 10px}
  /* í˜„í™©íŒ ë˜í¼ */
  .board-wrap{width:min(1600px,98vw);margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(20,119,201,.06);padding:8px;position:relative}
  .topbar{position:absolute;left:0;right:0;top:8px;display:flex;justify-content:center;align-items:center;pointer-events:none}
  .topbar img{height:28px; pointer-events:auto; cursor:pointer}
  .issue-fab{position:absolute;right:10px;top:10px;pointer-events:auto}
  .issue-fab .btn.small{cursor:pointer}
  .meta{position:absolute;left:8px;top:8px;width:220px}
  .meta div{display:flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:8px;padding:6px 8px;background:#fff;margin-bottom:6px;font-size:12px;color:#334}
  .grid-container{margin-top:62px}
  .grid{display:grid;grid-template-columns: var(--label-w) repeat(var(--cols), 1fr);gap:var(--gap)}
  .cell{height:var(--row-h);border:1px solid var(--line);border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;padding:2px 6px;overflow:hidden}
  .title{font-weight:800;color:#334155;background:#fbfcff;font-size:12px}
  .hdr{height:46px;font-weight:900;color:#133559;background:#fff;flex-direction:column;padding:4px}
  .mng-hdr{display:flex;flex-direction:column;line-height:1.05;align-items:center}
  .mng-name{font-size:12px;font-weight:900}
  .mng-os{font-size:10px;color:#64748b}
  .cell input{width:100%;height:26px;border:1px solid transparent;border-radius:8px;text-align:center;font-size:12px;background:#fff}
  .cell input:focus{outline:none;border-color:#1477C9;box-shadow:0 0 0 3px rgba(20,119,201,.12)}
  .rowgap{height:6px}
  /* ìš°ì¸¡ ë¡œê·¸ì‚¬ì´ë“œ */
  .side{position:fixed;right:0;top:0;height:100vh;width:min(420px,92vw);background:#fff;border-left:1px solid #e5e7eb;box-shadow:-8px 0 24px rgba(0,0,0,.08);
        transform:translateX(100%);transition:transform .25s ease;z-index:50;display:flex;flex-direction:column}
  .side.show{transform:translateX(0)}
  .side-hdr{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #eef2f7}
  .side-body{padding:10px 14px;overflow:auto}
  .log-item{padding:8px 0;border-bottom:1px dashed #e5e7eb;font-size:13px;color:#334}
  .close-x{background:#fff;border:1px solid #cdd7e5;border-radius:8px;padding:6px 8px;cursor:pointer}
  /* ëª¨ë‹¬ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:70}
  .modal.show{display:flex}
  .modal-card{width:min(860px,96vw);background:#fff;border-radius:14px;border:1px solid #e6ebf2;box-shadow:0 12px 32px rgba(0,0,0,.25);padding:14px}
  /* í† ìŠ¤íŠ¸ */
  .toast-wrap{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:60}
  .toast{background:#111;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.25);font-size:13px;opacity:.95}
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<audio id="alarm" src="alarm.mp3" preload="auto"></audio>

<!-- ë¡œê·¸ì¸ -->
<div id="login">
  <div class="login-card">
    <img src="title_logo.png" class="title-logo" alt="íƒ€ì´í‹€" onclick="show('login')" />
    <div class="login-row">
      <input id="login-code" type="password" placeholder="ë¡œê·¸ì¸ ì½”ë“œ" class="login-input" />
      <button class="btn" onclick="go()">ë¡œê·¸ì¸</button>
    </div>
  </div>
</div>

<!-- í˜„í™©íŒ -->
<div id="status" class="hidden">
  <div class="board-wrap">
    <div class="topbar"><img src="title_logo.png" alt="íƒ€ì´í‹€" onclick="show('login')" /></div>
    <div class="issue-fab"><button class="btn small" style="margin-right:6px;background:#475569" onclick="captureBoard()">ìº¡ì³</button><button class="btn small" id="issue-btn" onclick="openIssue()">ë¶ˆì¶œ</button></div>
    <div class="meta"><div>ğŸ”„ <span id="updated">ì—…ë°ì´íŠ¸ ì—†ìŒ</span></div></div>
    <div class="grid-container">
      <div id="grid-top" class="grid"></div>
      <div class="rowgap"></div>
      <div id="grid-bottom" class="grid"></div>
    </div>
  </div>
</div>

<!-- ë¶ˆì¶œ ëª¨ë‹¬ -->
<div id="issue-modal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:900;color:#133559">ë¶ˆì¶œ</div>
      <button class="close-x" onclick="closeIssue()">ë‹«ê¸°</button>
    </div>
    <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center">
      <div class="center" style="justify-content:flex-end;font-weight:800;color:#334155;font-size:13px">MNG</div>
      <select id="iss-mng" style="height:34px;border:1px solid #ccd7e6;border-radius:8px;padding:0 8px"></select>

      <div class="center" style="justify-content:flex-end;font-weight:800;color:#334155;font-size:13px">ì‚¬ìš©ì</div>
      <input id="iss-user" placeholder="" style="height:34px;border:1px solid #ccd7e6;border-radius:8px;padding:0 8px">

      <div class="center" style="justify-content:flex-end;font-weight:800;color:#334155;font-size:13px">ì‚¬ìš©ì íœ´ëŒ€í°</div>
      <input id="iss-user-phone" value="" disabled style="height:34px;border:1px dashed #ccd7e6;border-radius:8px;padding:0 8px;background:#fafafa;text-align:center">

      <div class="center" style="justify-content:flex-end;font-weight:800;color:#334155;font-size:13px">ì˜¤ë””ì˜¤ë§¨</div>
      <input id="iss-audio" placeholder="" style="height:34px;border:1px solid #ccd7e6;border-radius:8px;padding:0 8px">

      <div class="center" style="justify-content:flex-end;font-weight:800;color:#334155;font-size:13px">ì˜¤ë””ì˜¤ë§¨ íœ´ëŒ€í°</div>
      <input id="iss-audio-phone" value="" disabled style="height:34px;border:1px dashed #ccd7e6;border-radius:8px;padding:0 8px;background:#fafafa;text-align:center">

      <div class="center" style="justify-content:flex-end;font-weight:800;color:#334155;font-size:13px">ì‚¬ìš© ìœ„ì¹˜</div>
      <input id="iss-region" placeholder="" style="height:34px;border:1px solid #ccd7e6;border-radius:8px;padding:0 8px">

      <div class="center" style="justify-content:flex-end;font-weight:800;color:#334155;font-size:13px">ì•„ì´í…œ</div>
      <input id="iss-item" placeholder="" style="height:34px;border:1px solid #ccd7e6;border-radius:8px;padding:0 8px">

      <div class="center" style="justify-content:flex-end;font-weight:800;color:#334155;font-size:13px">ì¼ì •</div>
      <select id="iss-status" style="height:34px;border:1px solid #ccd7e6;border-radius:8px;padding:0 8px">
        <option value="base">ê¸°ë³¸ ì¼ì •(ì—°íšŒìƒ‰)</option>
        <option value="overseas">í•´ì™¸ ì¶œì¥(ì—°ì´ˆë¡)</option>
        <option value="bureau">ì§€êµ­(ì—°ë…¸ë‘)</option>
      </select>
    </div>
    <div style="display:flex;justify-content:center;margin-top:10px">
      <button class="btn" onclick="submitIssue()">ë¶ˆì¶œ</button>
    </div>
  </div>
</div>

<!-- ë¡œê·¸ ì‚¬ì´ë“œ -->
<aside id="side" class="side">
  <div class="side-hdr">
    <div><b id="side-title">MNG-?? ë¡œê·¸</b></div>
    <button class="close-x" onclick="toggleSide(false)">ë‹«ê¸°</button>
  </div>
  <div id="side-body" class="side-body"></div>
</aside>

<div id="toasts" class="toast-wrap"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, update, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  // ===== Firebase Config (ì œê³µí•˜ì‹  ê°’) =====
  const firebaseConfig = {
    apiKey: "AIzaSyADWorIbKPZZoWx7qAriiCA2lYtf-MSdAA",
    authDomain: "mbc-mng.firebaseapp.com",
    databaseURL: "https://mbc-mng-default-rtdb.firebaseio.com",
    projectId: "mbc-mng",
    storageBucket: "mbc-mng.firebasestorage.app",
    messagingSenderId: "845487713315",
    appId: "1:845487713315:web:d8559559fa98870fde5596"
  };

  let app = null, db = null; let ROLE='viewer'; // 'viewer' | 'editor'
  try { app = initializeApp(firebaseConfig); db = getDatabase(app); }
  catch(e){ console.warn('Firebase init skipped:', e); }

  const RTDB_URL = (firebaseConfig && firebaseConfig.databaseURL) ? firebaseConfig.databaseURL.replace(/\/+$/,'') : '';

  async function saveStatus(id, payload){
    const data = Object.assign({}, payload, { ts: serverTimestamp ? serverTimestamp() : null });
    if(db){
      try{ await set(ref(db, 'status/'+id), data); return true; }catch(e){ console.warn('SDK saveStatus failed', e); }
    }
    // REST fallback
    if(RTDB_URL){
      try{
        const res = await fetch(`${RTDB_URL}/status/${id}.json`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        return res.ok;
      }catch(e){ console.warn('REST saveStatus failed', e); }
    }
    return false;
  }

  async function appendLog(id, entry){
    const payload = Object.assign({}, entry, { ts: serverTimestamp ? serverTimestamp() : null });
    if(db){
      try{ await push(ref(db, 'logs/'+id), payload); return true; }catch(e){ console.warn('SDK appendLog failed', e); }
    }
    if(RTDB_URL){
      try{
        const res = await fetch(`${RTDB_URL}/logs/${id}.json`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(entry)});
        return res.ok;
      }catch(e){ console.warn('REST appendLog failed', e); }
    }
    return false;
  }

  // ===== ì „í™”ë²ˆí˜¸ ë§¤í•‘ (video.txt for ì‚¬ìš©ì / audio.txt for ì˜¤ë””ì˜¤ë§¨) =====
  const defaultPhone = "010-0000-0000";
  const mapVideo = new Map(), mapAudio = new Map(); let mapsLoaded=false;
  async function loadPhoneMaps(){
    try {
      const cb=Date.now();
      const [v,a] = await Promise.allSettled([fetch('video.txt?cb='+cb), fetch('audio.txt?cb='+cb)]);
      if(v.status==='fulfilled' && v.value.ok) parsePhoneFile(await v.value.text(), mapVideo);
      if(a.status==='fulfilled' && a.value.ok) parsePhoneFile(await a.value.text(), mapAudio);
      mapsLoaded=true;
    } catch(e){ console.warn('phone map error', e); }
  }
  function parsePhoneFile(text, targetMap){
    text.split(/\r?\n/).forEach(line=>{
      const raw=line.trim(); if(!raw) return;
      // name,number | name<TAB>number | name number
      const m = raw.match(/^\s*([^,\t]+)[,\t\s]+([0-9\-\s]+)\s*$/);
      if(!m) return;
      const name = m[1].trim();
      let digits = (m[2]||'').replace(/[^\d]/g,'');
      if(!name || digits.length<10) return;
      if(digits.length===10) digits='0'+digits;
      if(digits.length===11){
        const phone = digits.replace(/(\d{3})(\d{4})(\d{4})/,'$1-$2-$3');
        targetMap.set(name, phone);
      }
    });
  }
  const getUserPhone = (name) => mapVideo.get((name||'').trim()) || defaultPhone;
  const getAudioPhone= (name) => mapAudio.get((name||'').trim()) || defaultPhone;

  // ===== ê³µí†µ í•¨ìˆ˜ =====
  function toast(msg){
    const el=document.createElement('div'); el.className='toast'; el.textContent=msg;
    document.getElementById('toasts').appendChild(el);
    try{ const a=document.getElementById('alarm'); a.currentTime=0; a.play().catch(()=>{});}catch(_){}
    setTimeout(()=>el.style.opacity='0',1800); setTimeout(()=>el.remove(),2200);
  }
  function stampUpdate(ts){
    document.getElementById('updated').textContent = ts || new Date().toISOString().replace('T',' ').slice(0,19);
  }
  function statusLabel(s){ return s==='overseas'?'í•´ì™¸ì¶œì¥':s==='bureau'?'ì§€êµ­':s==='base'?'ê¸°ë³¸ì¼ì •':'(ë¬´)'; }

  window.show = (id)=>{
    document.getElementById('login').classList.toggle('hidden', id!=='login');
    document.getElementById('status').classList.toggle('hidden', id!=='status');
    if(id==='status'){ loadPhoneMaps().finally(()=>buildBoards()); }
    window.scrollTo(0,0);
  };

  window.go = ()=>{
    const code=(document.getElementById('login-code').value||'').trim();
    if(!code){ toast('ë¡œê·¸ì¸ ì½”ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if(code==='mbcmng2%'){ ROLE='editor'; toast('ê´€ë¦¬ ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
    else if(code==='mbcmng1!'){ ROLE='viewer'; toast('ì—´ëŒ ì „ìš©ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
    else { toast('ë¡œê·¸ì¸ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
    show('status');
  };

  // ===== í˜„í™©íŒ ë ˆì´ì•„ì›ƒ =====
  const TOP=[1,2,3,4,6,7,8,9,10,17], BOTTOM=[18,19,20,21,22,23,24,25,26,27];
  const osMap={1:"windows",2:"Linux v7",3:"windows",4:"windows",6:"windows",7:"windows",8:"Linux v7",9:"windows",10:"windows",17:"Linux v3",
               18:"Linux v3",19:"Linux v4",20:"Linux v4",21:"Linux v4",22:"Linux v4",23:"Linux v7",24:"Linux v7",25:"Linux v7",26:"Linux v7",27:"Linux v7"};
  const state={}, logs={}; [...TOP,...BOTTOM].forEach(n=>{ const id=`MNG-${String(n).padStart(2,'0')}`; state[id]={status:'none',userPhone:defaultPhone,audioPhone:defaultPhone}; logs[id]=[]; });

  function cell(text,cls=''){ const d=document.createElement('div'); d.className='cell '+cls; d.textContent=text; return d; }
  function mngHeaderCell(name, os, cid){ const d=cell('','hdr'); d.dataset.cid=cid; d.innerHTML=`<div class="mng-hdr"><div class="mng-name">${name}</div><div class="mng-os">${os}</div></div>`; return d; }

  function mountGrid(host, list){
    host.style.setProperty('--cols', list.length); host.innerHTML='';
    host.appendChild(cell('í•­ëª©','hdr title')).dataset.cid='LABEL';
    for(const n of list){ const id=`MNG-${String(n).padStart(2,'0')}`; host.appendChild(mngHeaderCell(id, osMap[n]||'', id)); }
    const labels=['ì·¨ì¬','ì‚¬ìš©ì','ì‚¬ìš©ìí°','ì˜¤ë””ì˜¤','ì˜¤ë””ì˜¤í°','ìœ„ì¹˜','ì•„ì´í…œ',''];
    for(const lab of labels){
      host.appendChild(cell(lab,'title')).dataset.cid='LABEL';
      for(const n of list){
        const id=`MNG-${String(n).padStart(2,'0')}`; const rec=state[id]||{}; const c=cell('', ''); c.dataset.cid=id;
        if(lab==='ì·¨ì¬'){ c.innerHTML=`<input data-id="${id}" data-field="reporter" value="${rec.reporter||''}" placeholder="">`; }
        else if(lab==='ì‚¬ìš©ì'){ c.innerHTML=`<input data-id="${id}" data-field="user" value="${rec.user||''}" placeholder="">`; }
        else if(lab==='ì‚¬ìš©ìí°'){ const val=(rec.userPhone&&rec.userPhone!==defaultPhone)?rec.userPhone:''; c.innerHTML=`<input data-id="${id}" data-field="userPhone" value="${val}" disabled>`; }
        else if(lab==='ì˜¤ë””ì˜¤'){ c.innerHTML=`<input data-id="${id}" data-field="audio" value="${rec.audio||''}" placeholder="">`; }
        else if(lab==='ì˜¤ë””ì˜¤í°'){ const val2=(rec.audioPhone&&rec.audioPhone!==defaultPhone)?rec.audioPhone:''; c.innerHTML=`<input data-id="${id}" data-field="audioPhone" value="${val2}" disabled>`; }
        else if(lab==='ìœ„ì¹˜'){ c.innerHTML=`<input data-id="${id}" data-field="region" value="${rec.region||''}" placeholder="">`; }
        else if(lab==='ì•„ì´í…œ'){ c.innerHTML=`<input data-id="${id}" data-field="item" value="${rec.item||''}" placeholder="">`; }
        else { c.innerHTML=`<button class="btn-return" data-return="${id}">ë°˜ë‚©</button>`; }
        host.appendChild(c);
      }
    }
    // ì…ë ¥ í•¸ë“¤ëŸ¬
    // Tab down navigation
    const editableOrder=['reporter','user','audio','region','item'];
    function nextFocus(el){
      const field=el.dataset.field, id=el.dataset.id;
      const mngs=[...TOP,...BOTTOM].map(n=>'MNG-'+String(n).padStart(2,'0'));
      const colIndex=mngs.indexOf(id);
      let idx=editableOrder.indexOf(field);
      // find next focus target: next field in same column, then first field of next column
      while(true){
        idx++;
        if(idx<editableOrder.length){
          const target=document.querySelector(`[data-cid='${id}'] input[data-field='${editableOrder[idx]}']`);
          if(target && !target.disabled){ target.focus(); return; }
          continue;
        }else{
          // move to next column start
          const nextCol = (colIndex+1) % mngs.length;
          const nextId = mngs[nextCol];
          const target=document.querySelector(`[data-cid='${nextId}'] input[data-field='${editableOrder[0]}']`);
          if(target && !target.disabled){ target.focus(); return; }
          return;
        }
      }
    }
    host.querySelectorAll('input[data-id]').forEach(el=>{
      el.addEventListener('keydown', (e)=>{
        if(e.key==='Tab' && !e.shiftKey){
          e.preventDefault();
          nextFocus(e.currentTarget);
        }
      });
      el.addEventListener('input', async e=>{
        if(ROLE!=='editor'){ e.target.value = state[e.target.dataset.id]?.[e.target.dataset.field] || e.target.value; toast('ì—´ëŒ ì „ìš© ê³„ì •ì…ë‹ˆë‹¤.'); return; }
        const id=e.target.dataset.id, field=e.target.dataset.field;
        state[id]=state[id]||{}; state[id][field]=e.target.value.trim();
        if((field==='user'||field==='audio') && !mapsLoaded){ await loadPhoneMaps(); }
        if(field==='user'){ state[id].userPhone=getUserPhone(state[id][field]); }
        if(field==='audio'){ state[id].audioPhone=getAudioPhone(state[id][field]); }

        // ìë™ ê¸°ë³¸ì¼ì • ì „í™˜ + ìµœì´ˆ ì „í™˜ ì‹œ ë¡œê·¸ê¸°ë¡
        const r=state[id]; const was=r.status||'none';
        const filled=(r.user?.trim()&&r.userPhone?.trim()&&r.audio?.trim()&&r.audioPhone?.trim()&&r.region?.trim()&&r.item?.trim());
        if(filled){ r.status='base'; }
        renderColumnValues(id); applyStatusStyles();
        const updated=new Date().toISOString().replace('T',' ').slice(0,19); stampUpdate(updated);
        if(db) debounceSync(id);
        if(filled && was!=='base' && was!=='bureau' && was!=='overseas'){
          const entry={type:'issue', user:r.user, region:r.region, item:r.item, status:'base', reporter:r.reporter||'', audio:r.audio, userPhone:r.userPhone, audioPhone:r.audioPhone, updated};
          pushLogLocal(id, entry);
          try{ await appendLog(id, entry); }catch(e){ console.warn(e); }
        }
      });
    });
    host.querySelectorAll('[data-return]').forEach(btn=>btn.addEventListener('click',e=>doReturn(e.target.dataset.return)));
    host.querySelectorAll('.hdr').forEach(h=>h.addEventListener('click',()=>openLogs(h.dataset.cid)));
  }

  function renderColumnValues(id){
    document.querySelectorAll(`[data-cid='${id}'] input[data-field]`).forEach(inp=>{
      const f=inp.dataset.field; if(f in (state[id]||{})){
        let v=state[id][f]??''; if((f==='userPhone'||f==='audioPhone') && (v===''||v===defaultPhone)) v='';
        inp.value=v;
      }
    });
  }

  function applyStatusStyles(){
    const ids=[...TOP,...BOTTOM].map(n=>`MNG-${String(n).padStart(2,'0')}`);
    for(const id of ids){
      const st=(state[id]&&state[id].status)||'none';
      const color = st==='overseas'?'var(--overseas)': st==='bureau'?'var(--bureau)': st==='base'?'var(--base)':'#fff';
      document.querySelectorAll(`[data-cid='${id}']`).forEach(el=>el.style.background=color);
    }
  }

  // ===== ë¡œê·¸ ì‚¬ì´ë“œ =====
  window.toggleSide=(f)=>document.getElementById('side').classList.toggle('show',!!f);
  function openLogs(id){
    const arr=logs[id]||[]; document.getElementById('side-title').textContent=`${id} Â· ìµœê·¼ ê¸°ë¡`;
    const body=document.getElementById('side-body'); body.innerHTML=arr.length?arr.slice(0,10).map(e=>`<div class="log-item">
      <div><b>${(e.updated)}</b> Â· ${e.type==='issue'?'ë¶ˆì¶œ':'ë°˜ë‚©'} (${statusLabel(e.status)})</div>
      <div>ì‚¬ìš©ì: ${e.user||'-'} Â· ìœ„ì¹˜: ${e.region||'-'} Â· ì•„ì´í…œ: ${e.item||'-'}</div>
    </div>`).join(''):'<div style="color:#667;font-size:13px">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    toggleSide(true);
  }
  function pushLogLocal(id, entry){ const arr=logs[id]||(logs[id]=[]); arr.unshift(Object.assign({ts:Date.now()},entry)); if(arr.length>10) arr.pop(); }

  // ===== ë¶ˆì¶œ ëª¨ë‹¬ =====
  async function ensurePhoneMaps(){ if(!mapsLoaded) await loadPhoneMaps(); }
  function buildIssue(){
    const sel=document.getElementById('iss-mng');
    if(!sel.dataset.filled){
      sel.innerHTML='<option value="" disabled selected>ì„ íƒ</option>'+[...TOP,...BOTTOM].map(n=>{
        const id=`MNG-${String(n).padStart(2,'0')}`; return `<option value="${id}">${id}</option>`;
      }).join(''); sel.dataset.filled='1';
    }
    const u=document.getElementById('iss-user'), a=document.getElementById('iss-audio');
    const up=document.getElementById('iss-user-phone'), ap=document.getElementById('iss-audio-phone');
    const syncU=()=>{ const p=getUserPhone(u.value||''); up.value=(p===defaultPhone?'':p); };
    const syncA=()=>{ const p=getAudioPhone(a.value||''); ap.value=(p===defaultPhone?'':p); };
    u.oninput=syncU; a.oninput=syncA; syncU(); syncA();
  }
  window.openIssue=async()=>{ if(ROLE!=='editor'){ toast('ì—´ëŒ ì „ìš© ê³„ì •ì…ë‹ˆë‹¤.'); return; } await ensurePhoneMaps(); buildIssue(); document.getElementById('issue-modal').classList.add('show'); };
  window.closeIssue=()=>document.getElementById('issue-modal').classList.remove('show');

  window.submitIssue=async()=>{
    if(ROLE!=='editor'){ toast('ì—´ëŒ ì „ìš© ê³„ì •ì…ë‹ˆë‹¤.'); return; }
    const m=document.getElementById('iss-mng').value, u=document.getElementById('iss-user').value.trim();
    const r=document.getElementById('iss-region').value.trim(), it=document.getElementById('iss-item').value.trim();
    const st=document.getElementById('iss-status').value;
    const up=document.getElementById('iss-user-phone').value || defaultPhone;
    const a=document.getElementById('iss-audio').value.trim(), ap=document.getElementById('iss-audio-phone').value || defaultPhone;
    if(!m||!u||!r){ toast('MNG, ì‚¬ìš©ì, ìœ„ì¹˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    const updated=new Date().toISOString().replace('T',' ').slice(0,19);
    const record={user:u, region:r, item:it, status:st, reporter:state[m].reporter||'', audio:a, userPhone:up, audioPhone:ap, updated};
    state[m]=Object.assign({},record); pushLogLocal(m,{type:'issue',...record}); stampUpdate(updated); applyStatusStyles(); renderColumnValues(m); toast('ë¶ˆì¶œ ì™„ë£Œ'); closeIssue();
    try{ await saveStatus(m, record); await appendLog(m, Object.assign({type:'issue'}, record)); }catch(e){ console.warn(e); toast('Firebase ë™ê¸°í™” ì‹¤íŒ¨'); }
  };

  // ===== ë°˜ë‚© =====
  async function doReturn(id){
    if(ROLE!=='editor'){ toast('ì—´ëŒ ì „ìš© ê³„ì •ì…ë‹ˆë‹¤.'); return; }
    const rec=state[id]||{}; const updated=new Date().toISOString().replace('T',' ').slice(0,19);
    pushLogLocal(id,{type:'return',...rec,updated}); state[id]={status:'none',userPhone:defaultPhone,audioPhone:defaultPhone};
    buildBoards(); stampUpdate(updated); toast('ë°˜ë‚© ì²˜ë¦¬');
    try{ await saveStatus(id, {status:'none',userPhone:defaultPhone,audioPhone:defaultPhone,updated}); await appendLog(id, Object.assign({type:'return'}, rec, {updated})); }catch(e){ console.warn(e); toast('Firebase ë™ê¸°í™” ì‹¤íŒ¨'); }
  }
  window.doReturn=doReturn;

  // ===== Firebase ì‹¤ì‹œê°„ ë°”ì¸ë”© =====
  function bindRealtimeOnce(){
    if(bindRealtimeOnce._done || !db) return; bindRealtimeOnce._done=true;
    [...TOP,...BOTTOM].forEach(n=>{
      const id=`MNG-${String(n).padStart(2,'0')}`;
      onValue(ref(db,`status/${id}`),(snap)=>{
        const v=snap.val(); if(v){ state[id]=Object.assign({userPhone:defaultPhone,audioPhone:defaultPhone},v); }
        renderColumnValues(id); applyStatusStyles(); stampUpdate(v&&v.updated?v.updated:null);
      });
      onValue(ref(db,`logs/${id}`),(snap)=>{
        const arr=[]; snap.forEach(ch=>arr.unshift(ch.val()));
        if(arr.length>0){
          // merge with existing local logs and de-duplicate by updated+type+item
          const key = (x)=>[x.updated,x.type,x.item||'',x.user||''].join('|');
          const map=new Map();
          [...arr, ...(logs[id]||[])].forEach(e=>{ if(e && e.updated) map.set(key(e), e); });
          logs[id] = Array.from(map.values()).slice(0,10);
        } // if no remote logs, keep local logs (do not overwrite)
      });
    });
  }

  // ===== ë™ê¸°í™” ë””ë°”ìš´ìŠ¤ =====
  const pending=new Map();
  function debounceSync(id){
    if(!db) return; clearTimeout(pending.get(id));
    const h=setTimeout(async()=>{
      const v=state[id]; const updated=new Date().toISOString().replace('T',' ').slice(0,19);
      try{ await saveStatus(id, Object.assign({}, v, {updated})); }catch(e){ console.warn(e); }
    },400); pending.set(id,h);
  }

  window.captureBoard = async function(){
    try{
      const node=document.querySelector('.board-wrap');
      const canvas=await html2canvas(node,{useCORS:true,backgroundColor:null,scale:2});
      if(navigator.clipboard && window.ClipboardItem){
        await new Promise(res=>canvas.toBlob(res));
        const blob=await new Promise(resolve=>canvas.toBlob(resolve,'image/png'));
        await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
        toast('í™”ë©´ ìº¡ì³ë¥¼ í´ë¦½ë³´ë“œì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
      }else{
        const link=document.createElement('a'); link.download='mng_board.png'; link.href=canvas.toDataURL('image/png'); link.click();
        toast('í´ë¦½ë³´ë“œ ë¯¸ì§€ì›: íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
      }
    }catch(e){ console.warn(e); toast('ìº¡ì³ ì‹¤íŒ¨'); }
  }

  function buildBoards(){
    const contTop=document.getElementById('grid-top'), contBottom=document.getElementById('grid-bottom');
    mountGrid(contTop, TOP); mountGrid(contBottom, BOTTOM); applyStatusStyles();
    // ê¶Œí•œ ë°˜ì˜
    const isViewer=(ROLE!=='editor');
    document.querySelectorAll('.grid input').forEach(inp=>{ inp.disabled = inp.disabled || isViewer || inp.dataset.field==='userPhone' || inp.dataset.field==='audioPhone'; });
    const ib=document.getElementById('issue-btn'); if(ib){ ib.disabled=isViewer; if(isViewer){ ib.style.opacity='0.5'; ib.style.cursor='not-allowed'; } else { ib.style.opacity='1'; ib.style.cursor='pointer'; } }
    document.querySelectorAll('.btn-return').forEach(b=>{ if(isViewer){ b.disabled=true; b.style.opacity='0.5'; b.style.cursor='not-allowed'; } });
    bindRealtimeOnce();
  }

  // ì´ˆê¸°ë¡œë“œ
  window.addEventListener('DOMContentLoaded',()=>{ loadPhoneMaps(); });
</script>
</body>
</html>
